<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>About Memory Barrier | My Wiki</title>
  <meta name="author" content="Shichao Yuan">
  
  <meta name="description" content="引言
什么是Memory Barrier？stackoverflow中有一个经典的回答：

For performance gains modern CPUs often execute instructions out of order to make maximum use of the ava">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="About Memory Barrier"/>
  <meta property="og:site_name" content="My Wiki"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">My Wiki</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">		
			<h1> About Memory Barrier</h1>
		</div>		
	



<div class="row post">
	<!-- cols -->
	
	<div class="col-md-9">
	

			

	<!-- content -->
	<div class="mypage">		
	    <h2 id="引言">引言</h2>
<p>什么是Memory Barrier？stackoverflow中有一个经典的<a href="http://stackoverflow.com/questions/286629/what-is-a-memory-fence" target="_blank" rel="external">回答</a>：</p>
<blockquote>
<p>For performance gains modern CPUs often execute instructions out of order to make maximum use of the available silicon (including memory read/writes). Because the hardware enforces instructions integrity you never notice this in a single thread of execution. However for multiple threads or environments with volatile memory (memory mapped I/O for example) this can lead to unpredictable behavior.</p>
</blockquote>
<blockquote>
<p>A memory fence/barrier is a class of instructions that mean memory read/writes occur in the order you expect. For example a ‘full fence’ means all read/writes before the fence are comitted before those after the fence.</p>
</blockquote>
<blockquote>
<p>Note memory fences are a hardware concept. In higher level languages we are used to dealing with mutexes and semaphores - these may well be implemented using memory fences at the low level and explicit use of memory barriers are not necessary. Use of memory barriers requires a careful study of the hardware architecture and more commonly found in device drivers than application code.</p>
</blockquote>
<blockquote>
<p>The CPU reordering is different from compiler optimisations - although the artefacts can be similar. You need to take separate measures to stop the compiler reordering your instructions if that may cause undesirable behaviour (e.g. use of the volatile keyword in C).</p>
</blockquote>
<p>从高级语言编程的角度，理解与掌握Memory Barrier是容易的，但是对于硬件角度的Memory Barrier却有很多疑惑。所有笔者尝试通过本文自上而下将整个story串起来。</p>
<h2 id="幼稚的例子">幼稚的例子</h2>
<p>这个例子的思路来在一个带有cancel功能的GUI程序。（这种方式绝对的幼稚，但是本文的目的不在于cancel功能的实现，所以在下文也不会完善该功能，所做的改动仅仅是为了展示memory barrier）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryBarrierDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> cancel;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="annotation">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">while</span> (!cancel) &#123;</span><br><span class="line">                                        i++;</span><br><span class="line">                                &#125;</span><br><span class="line">                                System.out.println(<span class="string">"Done!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                &#125;).start();</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"OS: "</span> + System.getProperty(<span class="string">"os.name"</span>) + <span class="string">" "</span> + System.getProperty(<span class="string">"os.arch"</span>) + <span class="string">"\n"</span></span><br><span class="line">                                + <span class="string">"JavaVersion: "</span> + System.getProperty(<span class="string">"java.version"</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2048</span>);</span><br><span class="line">                cancel = <span class="keyword">true</span>;</span><br><span class="line">                System.out.println(<span class="string">"flag cancel set to true"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>笔者只有一台古老的机器（Intel(R) Core(TM)2 Quad CPU Q6600 @ 2.40GHz），执行结果如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yuan<span class="variable">@yuan</span>-<span class="constant">HP</span><span class="symbol">:~/learn</span><span class="variable">$ </span>jdk1.<span class="number">7.0_25</span>/bin/java <span class="constant">MemoryBarrierDemo</span></span><br><span class="line"><span class="constant">OS</span><span class="symbol">:</span> <span class="constant">Linux</span> amd64</span><br><span class="line"><span class="constant">JavaVersion</span><span class="symbol">:</span> <span class="number">1.7</span>.<span class="number">0_25</span></span><br><span class="line"></span><br><span class="line">flag cancel set to <span class="keyword">true</span></span><br></pre></td></tr></table></figure>
<p>程序一直处于循环递增<code>i</code>的状态，没有退出。也就是说程序中启动的子线程“看不到”主线程对共享变量<code>cancel</code>的改动，这就是从高级语言层面所看到的memory barrier，想要让子线程“看到”改变，那么就得让改变“穿过”memory barrier。</p>
<p>如何做？在_Java Concurrency in Practice_的3.1节介绍了两种方法——locking和volatile variable。在此我们试着用volatile关键字，将前面程序中的<code>private static boolean cancel;</code>改为<code>private static volatile boolean cancel;</code>。再次编译执行程序，结果如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yuan<span class="variable">@yuan</span>-<span class="constant">HP</span><span class="symbol">:~/learn</span><span class="variable">$ </span>jdk1.<span class="number">7.0_25</span>/bin/java <span class="constant">MemoryBarrierDemo</span></span><br><span class="line"><span class="constant">OS</span><span class="symbol">:</span> <span class="constant">Linux</span> amd64</span><br><span class="line"><span class="constant">JavaVersion</span><span class="symbol">:</span> <span class="number">1.7</span>.<span class="number">0_25</span></span><br><span class="line"></span><br><span class="line">flag cancel set to <span class="keyword">true</span></span><br><span class="line"><span class="constant">Done</span>!</span><br><span class="line">yuan<span class="variable">@yuan</span>-<span class="constant">HP</span><span class="symbol">:~/learn</span>$</span><br></pre></td></tr></table></figure>
<p>如此程序就可以按照设想的那像正常退出了，很简单吧。</p>
<p>好的，下面就开始探索笔者困惑的部分了。</p>
<h2 id="汇编代码">汇编代码</h2>
<p>下面我们通过添加几个参数打印出反汇编的代码看看。</p>
<p>没有volatile的版本：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk1<span class="string">.7</span><span class="string">.0_25</span>/bin/java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly MemoryBarrierDemo</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM warning: PrintAssembly is enabled<span class="comment">; turning on DebugNonSafepoints to gain additional output</span></span><br><span class="line"><span class="label">OS:</span> Linux amd64</span><br><span class="line"><span class="label">JavaVersion:</span> <span class="number">1.7</span><span class="string">.0_25</span></span><br><span class="line"></span><br><span class="line">Loaded disassembler from /home/yuan/learn/jdk1<span class="string">.7</span><span class="string">.0_25</span>/jre/lib/amd64/hsdis-amd64.so</span><br><span class="line">Decoding compiled method <span class="number">0x00007fbe883df890</span>:</span><br><span class="line"><span class="label">Code:</span></span><br><span class="line">[Disassembling for mach=<span class="string">'i386:x86-64'</span>]</span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; <span class="string">'access$000'</span> <span class="string">'()Z'</span> <span class="keyword">in</span> <span class="string">'MemoryBarrierDemo'</span></span><br><span class="line">  #           [<span class="literal">sp</span>+<span class="number">0x20</span>]  (<span class="literal">sp</span> of caller)</span><br><span class="line">  <span class="number">0x00007fbe883df9c0</span>: <span class="keyword">sub</span>    <span class="number">$0</span>x18,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fbe883df9c7</span>: <span class="keyword">mov</span>    %<span class="literal">rbp</span>,<span class="number">0x10</span>(%<span class="literal">rsp</span>)    <span class="comment">;*synchronization entry</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@-1 (line 1)</span></span><br><span class="line">  <span class="number">0x00007fbe883df9cc</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebcfc590,%<span class="literal">r10</span>   <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883df9d6</span>: movzbl <span class="number">0x70</span>(%<span class="literal">r10</span>),%<span class="number">eax</span>    <span class="comment">;*getstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@0 (line 1)</span></span><br><span class="line">  <span class="number">0x00007fbe883df9db</span>: <span class="keyword">add</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fbe883df9df</span>: <span class="keyword">pop</span>    %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fbe883df9e0</span>: <span class="keyword">test</span>   %<span class="number">eax</span>,<span class="number">0x9c6b61a</span>(%<span class="literal">rip</span>)        # <span class="number">0x00007fbe9204b000</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll_return&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883df9e6</span>: retq</span><br><span class="line">  <span class="number">0x00007fbe883df9e7</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9e8</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9e9</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9ea</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9eb</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9ec</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9ed</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9ee</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9ef</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f0</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f1</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f2</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f3</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f4</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f5</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f6</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f7</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f8</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9f9</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9fa</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9fb</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9fc</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9fd</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9fe</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883df9ff</span>: <span class="keyword">hlt</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007fbe883dfa00</span>: jmpq   <span class="number">0x00007fbe883dc860</span>  <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007fbe883dfa05</span>: callq  <span class="number">0x00007fbe883dfa0a</span></span><br><span class="line">  <span class="number">0x00007fbe883dfa0a</span>: subq   <span class="number">$0</span>x5,(%<span class="literal">rsp</span>)</span><br><span class="line">  <span class="number">0x00007fbe883dfa0f</span>: jmpq   <span class="number">0x00007fbe883b6c00</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dfa14</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dfa15</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dfa16</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dfa17</span>: <span class="keyword">hlt</span></span><br><span class="line">Decoding compiled method <span class="number">0x00007fbe883ddcd0</span>:</span><br><span class="line"><span class="label">Code:</span></span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; <span class="string">'run'</span> <span class="string">'()V'</span> <span class="keyword">in</span> <span class="string">'MemoryBarrierDemo$1'</span></span><br><span class="line">  <span class="number">0x00007fbe883dde20</span>: callq  <span class="number">0x00007fbe90e52370</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dde25</span>: nopw   <span class="number">0x0</span>(%<span class="literal">rax</span>,%<span class="literal">rax</span>,<span class="number">1</span>)</span><br><span class="line">  <span class="number">0x00007fbe883dde30</span>: <span class="keyword">mov</span>    %<span class="number">eax</span>,-<span class="number">0x14000</span>(%<span class="literal">rsp</span>)</span><br><span class="line">  <span class="number">0x00007fbe883dde37</span>: <span class="keyword">push</span>   %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fbe883dde38</span>: <span class="keyword">sub</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fbe883dde3c</span>: <span class="keyword">mov</span>    (%<span class="literal">rsi</span>),%<span class="number">ebx</span></span><br><span class="line">  <span class="number">0x00007fbe883dde3e</span>: <span class="keyword">mov</span>    %<span class="literal">rsi</span>,%<span class="literal">rdi</span></span><br><span class="line">  <span class="number">0x00007fbe883dde41</span>: <span class="keyword">mov</span>    <span class="number">$0</span>x7fbe90edf400,%<span class="literal">r10</span></span><br><span class="line">  <span class="number">0x00007fbe883dde4b</span>: callq  *%<span class="literal">r10</span>              <span class="comment">;*invokestatic access$000</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@2 (line 10)</span></span><br><span class="line">  <span class="number">0x00007fbe883dde4e</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebcfc590,%<span class="literal">r10</span>   <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dde58</span>: movzbl <span class="number">0x70</span>(%<span class="literal">r10</span>),%<span class="literal">r11d</span></span><br><span class="line">  <span class="number">0x00007fbe883dde5d</span>: <span class="keyword">test</span>   %<span class="literal">r11d</span>,%<span class="literal">r11d</span></span><br><span class="line">  <span class="number">0x00007fbe883dde60</span>: <span class="keyword">jne</span>    <span class="number">0x00007fbe883dde6c</span>  <span class="comment">;*goto</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@11 (line 11)</span></span><br><span class="line">  <span class="number">0x00007fbe883dde62</span>: <span class="keyword">inc</span>    %<span class="number">ebx</span>               <span class="comment">; OopMap&#123;off=68&#125;</span></span><br><span class="line">                                                <span class="comment">;*goto</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@11 (line 11)</span></span><br><span class="line">  <span class="number">0x00007fbe883dde64</span>: <span class="keyword">test</span>   %<span class="number">eax</span>,<span class="number">0x9c6d196</span>(%<span class="literal">rip</span>)        # <span class="number">0x00007fbe9204b000</span></span><br><span class="line">                                                <span class="comment">;*goto</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@11 (line 11)</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dde6a</span>: <span class="keyword">jmp</span>    <span class="number">0x00007fbe883dde62</span></span><br><span class="line">  <span class="number">0x00007fbe883dde6c</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebcb0d10,%<span class="literal">r10</span>   <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'java/lang/System')&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dde76</span>: <span class="keyword">mov</span>    <span class="number">0x74</span>(%<span class="literal">r10</span>),%<span class="literal">r11d</span>   <span class="comment">;*getstatic out</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@14 (line 13)</span></span><br><span class="line">  <span class="number">0x00007fbe883dde7a</span>: <span class="keyword">test</span>   %<span class="literal">r11d</span>,%<span class="literal">r11d</span></span><br><span class="line">  <span class="number">0x00007fbe883dde7d</span>: <span class="keyword">je</span>     <span class="number">0x00007fbe883ddea0</span>  <span class="comment">;*ifne</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@5 (line 10)</span></span><br><span class="line">  <span class="number">0x00007fbe883dde7f</span>: <span class="keyword">mov</span>    %<span class="literal">r11</span>,%<span class="literal">rsi</span>          <span class="comment">;*getstatic out</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@14 (line 13)</span></span><br><span class="line">  <span class="number">0x00007fbe883dde82</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebd4b960,%<span class="literal">rdx</span>   <span class="comment">;   &#123;oop("Done!")&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dde8c</span>: <span class="keyword">xchg</span>   %<span class="number">ax</span>,%<span class="number">ax</span></span><br><span class="line">  <span class="number">0x00007fbe883dde8f</span>: callq  <span class="number">0x00007fbe883b5c60</span>  <span class="comment">; OopMap&#123;off=116&#125;</span></span><br><span class="line">                                                <span class="comment">;*invokevirtual println</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@19 (line 13)</span></span><br><span class="line">                                                <span class="comment">;   &#123;optimized virtual_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dde94</span>: <span class="keyword">add</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fbe883dde98</span>: <span class="keyword">pop</span>    %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fbe883dde99</span>: <span class="keyword">test</span>   %<span class="number">eax</span>,<span class="number">0x9c6d161</span>(%<span class="literal">rip</span>)        # <span class="number">0x00007fbe9204b000</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll_return&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883dde9f</span>: retq</span><br><span class="line">  <span class="number">0x00007fbe883ddea0</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xfffffff6,%<span class="literal">esi</span></span><br><span class="line">  <span class="number">0x00007fbe883ddea5</span>: <span class="keyword">xchg</span>   %<span class="number">ax</span>,%<span class="number">ax</span></span><br><span class="line">  <span class="number">0x00007fbe883ddea7</span>: callq  <span class="number">0x00007fbe883b7020</span>  <span class="comment">; OopMap&#123;off=140&#125;</span></span><br><span class="line">                                                <span class="comment">;*invokevirtual println</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@19 (line 13)</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeac</span>: callq  <span class="number">0x00007fbe90e52370</span>  <span class="comment">;*invokevirtual println</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@19 (line 13)</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeb1</span>: <span class="keyword">mov</span>    %<span class="literal">rax</span>,%<span class="literal">rsi</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeb4</span>: <span class="keyword">add</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeb8</span>: <span class="keyword">pop</span>    %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeb9</span>: jmpq   <span class="number">0x00007fbe883df5e0</span>  <span class="comment">;*iinc</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@8 (line 11)</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883ddebe</span>: callq  <span class="number">0x00007fbe90e52370</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883ddec3</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddec4</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddec5</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddec6</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddec7</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddec8</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddec9</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeca</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddecb</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddecc</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddecd</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddece</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddecf</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded0</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded1</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded2</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded3</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded4</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded5</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded6</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded7</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded8</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883dded9</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeda</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddedb</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddedc</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddedd</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddede</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddedf</span>: <span class="keyword">hlt</span></span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007fbe883ddee0</span>: <span class="keyword">mov</span>    <span class="number">$0</span>x0,%<span class="literal">rbx</span>          <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883ddeea</span>: jmpq   <span class="number">0x00007fbe883ddeea</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">  <span class="number">0x00007fbe883ddeef</span>: jmpq   <span class="number">0x00007fbe883dc860</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007fbe883ddef4</span>: callq  <span class="number">0x00007fbe883ddef9</span></span><br><span class="line">  <span class="number">0x00007fbe883ddef9</span>: subq   <span class="number">$0</span>x5,(%<span class="literal">rsp</span>)</span><br><span class="line">  <span class="number">0x00007fbe883ddefe</span>: jmpq   <span class="number">0x00007fbe883b6c00</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fbe883ddf03</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddf04</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddf05</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddf06</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fbe883ddf07</span>: <span class="keyword">hlt</span></span><br><span class="line">flag cancel set to true</span><br></pre></td></tr></table></figure>
<p>带有volatile的版本：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk1<span class="string">.7</span><span class="string">.0_25</span>/bin/java -XX:+UnlockDiagnosticVMOptions -XX:+PrintAssembly MemoryBarrierDemo</span><br><span class="line">Java HotSpot(TM) <span class="number">64</span>-Bit Server VM warning: PrintAssembly is enabled<span class="comment">; turning on DebugNonSafepoints to gain additional output</span></span><br><span class="line"><span class="label">OS:</span> Linux amd64</span><br><span class="line"><span class="label">JavaVersion:</span> <span class="number">1.7</span><span class="string">.0_25</span></span><br><span class="line"></span><br><span class="line">Loaded disassembler from /home/yuan/learn/jdk1<span class="string">.7</span><span class="string">.0_25</span>/jre/lib/amd64/hsdis-amd64.so</span><br><span class="line">Decoding compiled method <span class="number">0x00007fb865061890</span>:</span><br><span class="line"><span class="label">Code:</span></span><br><span class="line">[Disassembling for mach=<span class="string">'i386:x86-64'</span>]</span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; <span class="string">'access$000'</span> <span class="string">'()Z'</span> <span class="keyword">in</span> <span class="string">'MemoryBarrierDemo'</span></span><br><span class="line">  #           [<span class="literal">sp</span>+<span class="number">0x20</span>]  (<span class="literal">sp</span> of caller)</span><br><span class="line">  <span class="number">0x00007fb8650619c0</span>: <span class="keyword">sub</span>    <span class="number">$0</span>x18,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fb8650619c7</span>: <span class="keyword">mov</span>    %<span class="literal">rbp</span>,<span class="number">0x10</span>(%<span class="literal">rsp</span>)    <span class="comment">;*synchronization entry</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@-1 (line 1)</span></span><br><span class="line">  <span class="number">0x00007fb8650619cc</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebcfc590,%<span class="literal">r10</span>   <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line">  <span class="number">0x00007fb8650619d6</span>: movzbl <span class="number">0x70</span>(%<span class="literal">r10</span>),%<span class="number">eax</span>    <span class="comment">;*getstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@0 (line 1)</span></span><br><span class="line">  <span class="number">0x00007fb8650619db</span>: <span class="keyword">add</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fb8650619df</span>: <span class="keyword">pop</span>    %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fb8650619e0</span>: <span class="keyword">test</span>   %<span class="number">eax</span>,<span class="number">0xb55e61a</span>(%<span class="literal">rip</span>)        # <span class="number">0x00007fb8705c0000</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll_return&#125;</span></span><br><span class="line">  <span class="number">0x00007fb8650619e6</span>: retq</span><br><span class="line">  <span class="number">0x00007fb8650619e7</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619e8</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619e9</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619ea</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619eb</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619ec</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619ed</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619ee</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619ef</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f0</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f1</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f2</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f3</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f4</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f5</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f6</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f7</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f8</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619f9</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619fa</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619fb</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619fc</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619fd</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619fe</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb8650619ff</span>: <span class="keyword">hlt</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007fb865061a00</span>: jmpq   <span class="number">0x00007fb86505e860</span>  <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007fb865061a05</span>: callq  <span class="number">0x00007fb865061a0a</span></span><br><span class="line">  <span class="number">0x00007fb865061a0a</span>: subq   <span class="number">$0</span>x5,(%<span class="literal">rsp</span>)</span><br><span class="line">  <span class="number">0x00007fb865061a0f</span>: jmpq   <span class="number">0x00007fb865038c00</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fb865061a14</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb865061a15</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb865061a16</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb865061a17</span>: <span class="keyword">hlt</span></span><br><span class="line">Decoding compiled method <span class="number">0x00007fb86505fc90</span>:</span><br><span class="line"><span class="label">Code:</span></span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; <span class="string">'run'</span> <span class="string">'()V'</span> <span class="keyword">in</span> <span class="string">'MemoryBarrierDemo$1'</span></span><br><span class="line">  <span class="number">0x00007fb86505fde0</span>: callq  <span class="number">0x00007fb86f3c7370</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fde5</span>: nopw   <span class="number">0x0</span>(%<span class="literal">rax</span>,%<span class="literal">rax</span>,<span class="number">1</span>)</span><br><span class="line">  <span class="number">0x00007fb86505fdf0</span>: <span class="keyword">mov</span>    %<span class="number">eax</span>,-<span class="number">0x14000</span>(%<span class="literal">rsp</span>)</span><br><span class="line">  <span class="number">0x00007fb86505fdf7</span>: <span class="keyword">push</span>   %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fb86505fdf8</span>: <span class="keyword">sub</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fb86505fdfc</span>: <span class="keyword">mov</span>    (%<span class="literal">rsi</span>),%<span class="literal">ebp</span></span><br><span class="line">  <span class="number">0x00007fb86505fdfe</span>: <span class="keyword">mov</span>    %<span class="literal">rsi</span>,%<span class="literal">rdi</span></span><br><span class="line">  <span class="number">0x00007fb86505fe01</span>: <span class="keyword">mov</span>    <span class="number">$0</span>x7fb86f454400,%<span class="literal">r10</span></span><br><span class="line">  <span class="number">0x00007fb86505fe0b</span>: callq  *%<span class="literal">r10</span>              <span class="comment">;*synchronization entry</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@-1 (line 1)</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@2 (line 10)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe0e</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebcfc590,%<span class="literal">r10</span>   <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe18</span>: movzbl <span class="number">0x70</span>(%<span class="literal">r10</span>),%<span class="literal">r8d</span>    <span class="comment">;*getstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@0 (line 1)</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@2 (line 10)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe1d</span>: <span class="keyword">test</span>   %<span class="literal">r8d</span>,%<span class="literal">r8d</span></span><br><span class="line">  <span class="number">0x00007fb86505fe20</span>: <span class="keyword">jne</span>    <span class="number">0x00007fb86505fe42</span>  <span class="comment">;*ifne</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@5 (line 10)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe22</span>: nopw   <span class="number">0x0</span>(%<span class="literal">rax</span>,%<span class="literal">rax</span>,<span class="number">1</span>)</span><br><span class="line">  <span class="number">0x00007fb86505fe2c</span>: <span class="keyword">xchg</span>   %<span class="number">ax</span>,%<span class="number">ax</span>            <span class="comment">;*iinc</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@8 (line 11)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe30</span>: movzbl <span class="number">0x70</span>(%<span class="literal">r10</span>),%<span class="literal">r11d</span>   <span class="comment">;*getstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@0 (line 1)</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@2 (line 10)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe35</span>: <span class="keyword">inc</span>    %<span class="literal">ebp</span>               <span class="comment">; OopMap&#123;r10=Oop off=87&#125;</span></span><br><span class="line">                                                <span class="comment">;*goto</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@11 (line 11)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe37</span>: <span class="keyword">test</span>   %<span class="number">eax</span>,<span class="number">0xb5601c3</span>(%<span class="literal">rip</span>)        # <span class="number">0x00007fb8705c0000</span></span><br><span class="line">                                                <span class="comment">;*getstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@0 (line 1)</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@2 (line 10)</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe3d</span>: <span class="keyword">test</span>   %<span class="literal">r11d</span>,%<span class="literal">r11d</span></span><br><span class="line">  <span class="number">0x00007fb86505fe40</span>: <span class="keyword">je</span>     <span class="number">0x00007fb86505fe30</span>  <span class="comment">;*ifne</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@5 (line 10)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe42</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebcb0d10,%<span class="literal">r10</span>   <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'java/lang/System')&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe4c</span>: <span class="keyword">mov</span>    <span class="number">0x74</span>(%<span class="literal">r10</span>),%<span class="literal">r10d</span>   <span class="comment">;*getstatic out</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@14 (line 13)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe50</span>: <span class="keyword">test</span>   %<span class="literal">r10d</span>,%<span class="literal">r10d</span></span><br><span class="line">  <span class="number">0x00007fb86505fe53</span>: <span class="keyword">je</span>     <span class="number">0x00007fb86505fe74</span>  <span class="comment">;*invokevirtual println</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@19 (line 13)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe55</span>: <span class="keyword">mov</span>    %<span class="literal">r10</span>,%<span class="literal">rsi</span>          <span class="comment">;*getstatic out</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@14 (line 13)</span></span><br><span class="line">  <span class="number">0x00007fb86505fe58</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xebd4b960,%<span class="literal">rdx</span>   <span class="comment">;   &#123;oop("Done!")&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe62</span>: <span class="keyword">nop</span></span><br><span class="line">  <span class="number">0x00007fb86505fe63</span>: callq  <span class="number">0x00007fb865037c60</span>  <span class="comment">; OopMap&#123;off=136&#125;</span></span><br><span class="line">                                                <span class="comment">;*invokevirtual println</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@19 (line 13)</span></span><br><span class="line">                                                <span class="comment">;   &#123;optimized virtual_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe68</span>: <span class="keyword">add</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fb86505fe6c</span>: <span class="keyword">pop</span>    %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fb86505fe6d</span>: <span class="keyword">test</span>   %<span class="number">eax</span>,<span class="number">0xb56018d</span>(%<span class="literal">rip</span>)        # <span class="number">0x00007fb8705c0000</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll_return&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe73</span>: retq</span><br><span class="line">  <span class="number">0x00007fb86505fe74</span>: <span class="keyword">mov</span>    <span class="number">$0</span>xfffffff6,%<span class="literal">esi</span></span><br><span class="line">  <span class="number">0x00007fb86505fe79</span>: <span class="keyword">xchg</span>   %<span class="number">ax</span>,%<span class="number">ax</span></span><br><span class="line">  <span class="number">0x00007fb86505fe7b</span>: callq  <span class="number">0x00007fb865039020</span>  <span class="comment">; OopMap&#123;off=160&#125;</span></span><br><span class="line">                                                <span class="comment">;*invokevirtual println</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@19 (line 13)</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe80</span>: callq  <span class="number">0x00007fb86f3c7370</span>  <span class="comment">;*invokevirtual println</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo$1::run@19 (line 13)</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe85</span>: <span class="keyword">mov</span>    %<span class="literal">rax</span>,%<span class="literal">rsi</span></span><br><span class="line">  <span class="number">0x00007fb86505fe88</span>: <span class="keyword">add</span>    <span class="number">$0</span>x10,%<span class="literal">rsp</span></span><br><span class="line">  <span class="number">0x00007fb86505fe8c</span>: <span class="keyword">pop</span>    %<span class="literal">rbp</span></span><br><span class="line">  <span class="number">0x00007fb86505fe8d</span>: jmpq   <span class="number">0x00007fb8650615e0</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fe92</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe93</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe94</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe95</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe96</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe97</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe98</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe99</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe9a</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe9b</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe9c</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe9d</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe9e</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fe9f</span>: <span class="keyword">hlt</span></span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007fb86505fea0</span>: <span class="keyword">mov</span>    <span class="number">$0</span>x0,%<span class="literal">rbx</span>          <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505feaa</span>: jmpq   <span class="number">0x00007fb86505feaa</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">  <span class="number">0x00007fb86505feaf</span>: jmpq   <span class="number">0x00007fb86505e860</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007fb86505feb4</span>: callq  <span class="number">0x00007fb86505feb9</span></span><br><span class="line">  <span class="number">0x00007fb86505feb9</span>: subq   <span class="number">$0</span>x5,(%<span class="literal">rsp</span>)</span><br><span class="line">  <span class="number">0x00007fb86505febe</span>: jmpq   <span class="number">0x00007fb865038c00</span>  <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007fb86505fec3</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fec4</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fec5</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fec6</span>: <span class="keyword">hlt</span></span><br><span class="line">  <span class="number">0x00007fb86505fec7</span>: <span class="keyword">hlt</span></span><br><span class="line">flag cancel set to true</span><br><span class="line">Done!</span><br><span class="line">yuan@yuan-HP:~/learn$</span><br></pre></td></tr></table></figure>
<p>现在我们分析一下。在没有volatile的版本中，循环递增部分的汇编代码很有趣，</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00007fbe883dde58</span>: movzbl <span class="number">0x70</span>(%<span class="literal">r10</span>),%<span class="literal">r11d</span></span><br><span class="line"><span class="number">0x00007fbe883dde5d</span>: <span class="keyword">test</span>   %<span class="literal">r11d</span>,%<span class="literal">r11d</span></span><br><span class="line"><span class="number">0x00007fbe883dde60</span>: <span class="keyword">jne</span>    <span class="number">0x00007fbe883dde6c</span>  <span class="comment">;*goto</span></span><br><span class="line">                                              <span class="comment">; - MemoryBarrierDemo$1::run@11 (line 11)</span></span><br><span class="line"><span class="number">0x00007fbe883dde62</span>: <span class="keyword">inc</span>    %<span class="number">ebx</span>               <span class="comment">; OopMap&#123;off=68&#125;</span></span><br><span class="line">                                              <span class="comment">;*goto</span></span><br><span class="line">                                              <span class="comment">; - MemoryBarrierDemo$1::run@11 (line 11)</span></span><br><span class="line"><span class="number">0x00007fbe883dde64</span>: <span class="keyword">test</span>   %<span class="number">eax</span>,<span class="number">0x9c6d196</span>(%<span class="literal">rip</span>)        # <span class="number">0x00007fbe9204b000</span></span><br><span class="line">                                              <span class="comment">;*goto</span></span><br><span class="line">                                              <span class="comment">; - MemoryBarrierDemo$1::run@11 (line 11)</span></span><br><span class="line">                                              <span class="comment">;   &#123;poll&#125;</span></span><br><span class="line"><span class="number">0x00007fbe883dde6a</span>: <span class="keyword">jmp</span>    <span class="number">0x00007fbe883dde62</span></span><br></pre></td></tr></table></figure>
<p>进入循环时检查过一次<code>cancel</code>，但是在后面却成了<code>jmp</code>无条件跳转，可想而知这肯定是编译器的“功劳”。在此笔者就先不深究这里所做的编译优化的原因了，只是简单的相信编译器已经获得了足够多的信息来判断<code>cancel</code>值在该线程是不变的。反过来推理，编译器的开发者肯定是对硬件层面的memory barrier有深入的理解才会做这个优化，这样也是本文想要探索的。</p>
<p>在带有volatile的版本中，循环递增部分的汇编代码如下：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00007fb86505fe18</span>: movzbl <span class="number">0x70</span>(<span class="variable">%r10</span>),<span class="variable">%r8d</span>    ;*getstatic cancel</span><br><span class="line">                                              ; - MemoryBarrierDemo::access<span class="variable">$0</span>0<span class="number">0</span><span class="variable">@0</span> (line <span class="number">1</span>)</span><br><span class="line">                                              ; - MemoryBarrierDemo<span class="variable">$1</span>::run<span class="variable">@2</span> (line <span class="number">10</span>)</span><br><span class="line"><span class="number">0x00007fb86505fe1d</span>: test   <span class="variable">%r8d</span>,<span class="variable">%r8d</span></span><br><span class="line"><span class="number">0x00007fb86505fe20</span>: jne    <span class="number">0x00007fb86505fe42</span>  ;*ifne</span><br><span class="line">                                              ; - MemoryBarrierDemo<span class="variable">$1</span>::run<span class="variable">@5</span> (line <span class="number">10</span>)</span><br><span class="line"><span class="number">0x00007fb86505fe22</span>: nopw   <span class="number">0x0</span>(<span class="variable">%rax</span>,<span class="variable">%rax</span>,<span class="number">1</span>)</span><br><span class="line"><span class="number">0x00007fb86505fe2c</span>: xchg   <span class="variable">%ax</span>,<span class="variable">%ax</span>            ;*iinc</span><br><span class="line">                                              ; - MemoryBarrierDemo<span class="variable">$1</span>::run<span class="variable">@8</span> (line <span class="number">11</span>)</span><br><span class="line"><span class="number">0x00007fb86505fe30</span>: movzbl <span class="number">0x70</span>(<span class="variable">%r10</span>),<span class="variable">%r11d</span>   ;*getstatic cancel</span><br><span class="line">                                              ; - MemoryBarrierDemo::access<span class="variable">$0</span>0<span class="number">0</span><span class="variable">@0</span> (line <span class="number">1</span>)</span><br><span class="line">                                              ; - MemoryBarrierDemo<span class="variable">$1</span>::run<span class="variable">@2</span> (line <span class="number">10</span>)</span><br><span class="line"><span class="number">0x00007fb86505fe35</span>: inc    <span class="variable">%ebp</span>               ; OopMap&#123;r1<span class="number">0</span>=Oop off=<span class="number">87</span>&#125;</span><br><span class="line">                                              ;*<span class="keyword">goto</span></span><br><span class="line">                                              ; - MemoryBarrierDemo<span class="variable">$1</span>::run<span class="variable">@11</span> (line <span class="number">11</span>)</span><br><span class="line"><span class="number">0x00007fb86505fe37</span>: test   <span class="variable">%eax</span>,<span class="number">0xb5601c3</span>(<span class="variable">%rip</span>)        <span class="comment"># 0x00007fb8705c0000</span></span><br><span class="line">                                              ;*getstatic cancel</span><br><span class="line">                                              ; - MemoryBarrierDemo::access<span class="variable">$0</span>0<span class="number">0</span><span class="variable">@0</span> (line <span class="number">1</span>)</span><br><span class="line">                                              ; - MemoryBarrierDemo<span class="variable">$1</span>::run<span class="variable">@2</span> (line <span class="number">10</span>)</span><br><span class="line">                                              ;   <span class="string">&#123;poll&#125;</span></span><br><span class="line"><span class="number">0x00007fb86505fe3d</span>: test   <span class="variable">%r11d</span>,<span class="variable">%r11d</span></span><br><span class="line"><span class="number">0x00007fb86505fe40</span>: je     <span class="number">0x00007fb86505fe30</span>  ;*ifne</span><br><span class="line">                                              ; - MemoryBarrierDemo<span class="variable">$1</span>::run<span class="variable">@5</span> (line <span class="number">10</span>)</span><br><span class="line"><span class="number">0x00007fb86505fe42</span>: mov    <span class="variable">$0</span>xebcb0d1<span class="number">0</span>,<span class="variable">%r10</span>   ;   &#123;oop(a <span class="string">'java/lang/Class'</span> = <span class="string">'java/lang/System'</span>)&#125;</span><br></pre></td></tr></table></figure>
<p>该版本的主要不同是在于获取cacel前执行了<code>xchg   %ax,%ax</code>。</p>
<p>xchg是什么东东？查_Intel 64 and IA-32 Architectures Software Developer’s Manual Combined Volumes 3A, 3B, and 3C: System Programming Guide_：</p>
<p>8-3页：</p>
<blockquote>
<p>8.1.2 Bus Locking</p>
</blockquote>
<blockquote>
<p>Intel 64 and IA-32 processors provide a LOCK# signal that is asserted automatically during certain critical memory operations to lock the system bus or equivalent link. While this output signal is asserted, requests from other processors or bus agents for control of the bus are blocked. Software can specify other occasions when the LOCK semantics are to be followed by prepending the LOCK prefix to an instruction.</p>
</blockquote>
<blockquote>
<p>In the case of the Intel386, Intel486, and Pentium processors , explicitly locked instructions will result in the assertion of the LOCK# signal. It is the responsibility of the hardware designer to make the LOCK# signal available in system hardware to control memory accesses among processors.</p>
</blockquote>
<blockquote>
<p>For the P6 and more recent processor families, if the memory area being accessed is cached internally in the processor, the LOCK# signal is generally not asserted; instead, locking is only applied to the processor’s caches (see Section 8.1.4, “Effects of a LOCK Operation on Internal Processor Caches”).</p>
</blockquote>
<blockquote>
<p>8.1.2.1 Automatic Locking</p>
</blockquote>
<blockquote>
<p>The operations on which the processor automatically follows the LOCK semantics are as follows:</p>
</blockquote>
<blockquote>
<p>• When executing an XCHG instruction that references memory.</p>
</blockquote>
<p>8-15页：</p>
<blockquote>
<p>Synchronization mechanisms in multiple-processor systems may depend upon a strong memory-ordering model. Here, a program can use a locking instruction such as the XCHG instruction or the LOCK prefix to ensure that a read-modify-write operation on memory is carried out atomically. Locking operations typically operate like I/O operations in that they wait for all previous instructions to complete and for all buffered writes to drain to memory (see Section 8.1.2, “Bus Locking”).</p>
</blockquote>
<p>8-16页：</p>
<blockquote>
<p>Intel recommends that software written to run on Intel Core 2 Duo, Intel Atom, Intel Core Duo, Pentium 4, Intel Xeon, and P6 family processors assume the processor-ordering model or a weaker memory-ordering model. The Intel Core 2 Duo, Intel Atom, Intel Core Duo, Pentium 4, Intel Xeon, and P6 family processors do not implement a strong memory-ordering model, except when using the UC memory type. Despite the fact that Pentium 4, Intel Xeon, and P6 family processors support processor ordering, Intel does not guarantee that future processors will support this model. To make software portable to futu re processors, it is recommended that operating systems provide critical region and resource control constructs and API’s (application program interfaces) based on I/O, locking, and/or serializing instructions be used to synchronize access to shared areas of memory in multiple-processor systems. Also, software should not depend on processor ordering in situations where the system hardware does not support this memory-ordering model.</p>
</blockquote>
<p>读完之后，笔者大致了解了三点：</p>
<ol style="list-style-type: decimal">
<li><p>执行XCHG指令会自动跟随LOCK语义；</p></li>
<li><p>locking操作会等待前面所有的指令完成，并且将所有buffered writes写到内存；</p></li>
<li><p>memory-ordering model的强度是变化的，软件不能依赖processor ordering。这就解释了第一个版本中的编译优化，编译器从高级语言中得不到显式的信息（比如Locking和volatile），所以就默认使用processor-ordering model，编译器就会尽可能的优化性能；而在第二个版本中，有显式的volatile关键字，所以编译器就会加入XCHG指令，以实现strong memory-ordering model。</p></li>
</ol>
<p>等一下，好像哪里有问题。就算<code>xchg</code>触发了<code>LOCK</code>语义，但是缓存中的<code>cancel</code>并没有改变，所以也不会触发cache coherency protocol；就算<code>cancel</code>所在的cache line由于别的原因被修改了，而此前主线程没有对<code>cancel</code>进行修改的话，也是没有用呀。再从头开始想想这个逻辑，如果让笔者设计编译器，笔者应该会在<code>cancel = true;</code>这行之后加上LOCK语义。再回过头看看汇编代码，竟然找不到对应的代码！</p>
<p>经过笔者多次尝试，最后通过加入<code>-Xcomp</code>打印出了所需的信息，另外对Java代码也做了点儿改动。（笔者对此有蛮多疑惑，暂且存疑吧-_-）</p>
<p>修改后的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryBarrierDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> cancel = <span class="keyword">false</span>;</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setCancel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                cancel = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                        <span class="annotation">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">                                <span class="keyword">while</span> (!cancel) &#123;</span><br><span class="line">                                        i++;</span><br><span class="line">                                &#125;</span><br><span class="line">                                System.out.println(<span class="string">"Done!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                &#125;).start();</span><br><span class="line"></span><br><span class="line">                System.out.println(<span class="string">"OS: "</span> + System.getProperty(<span class="string">"os.name"</span>) + <span class="string">" "</span> + System.getProperty(<span class="string">"os.arch"</span>) + <span class="string">"\n"</span></span><br><span class="line">                                + <span class="string">"JavaVersion: "</span> + System.getProperty(<span class="string">"java.version"</span>) + <span class="string">"\n"</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2048</span>);</span><br><span class="line">                <span class="comment">//cancel = true;</span></span><br><span class="line">                setCancel();</span><br><span class="line">                System.out.println(<span class="string">"flag cancel set to true"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>汇编代码如下：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br></pre></td><td class="code"><pre><span class="line">yuan@yuan-HP:~/learn$ jdk<span class="number">1.7.0_25</span>/bin/java -Xcomp  -XX:+UnlockDiagnosticVMOptions -XX:PrintAssemblyOptions=hsdis-print-bytes -XX:CompileCommand=print,MemoryBarrierDemo.* MemoryBarrierDemo</span><br><span class="line">CompilerOracle: print MemoryBarrierDemo.*</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM warning: printing of assembly code is enabled<span class="comment">; turning on DebugNonSafepoints to gain additional output</span></span><br><span class="line">Compiled method (c2)     888  370             MemoryBarrierDemo<span class="number">::</span>&lt;clinit&gt; (5 bytes)</span><br><span class="line"> total in heap  [<span class="number">0x00007</span>fbaec8ae<span class="number">2d0,0x00</span>007fbaec8ae4a0] = 464</span><br><span class="line"> relocation     [<span class="number">0x00007</span>fbaec8ae<span class="number">3f0,0x00</span>007fbaec8ae400] = 16</span><br><span class="line"> main code      [<span class="number">0x00007</span>fbaec8ae<span class="number">400,0x00</span>007fbaec8ae440] = 64</span><br><span class="line"> stub code      [<span class="number">0x00007</span>fbaec8ae<span class="number">440,0x00</span>007fbaec8ae458] = 24</span><br><span class="line"> oops           [<span class="number">0x00007</span>fbaec8ae<span class="number">458,0x00</span>007fbaec8ae460] = 8</span><br><span class="line"> scopes data    [<span class="number">0x00007</span>fbaec8ae<span class="number">460,0x00</span>007fbaec8ae468] = 8</span><br><span class="line"> scopes pcs     [<span class="number">0x00007</span>fbaec8ae<span class="number">468,0x00</span>007fbaec8ae498] = 48</span><br><span class="line"> dependencies   [<span class="number">0x00007</span>fbaec8ae<span class="number">498,0x00</span>007fbaec8ae4a0] = 8</span><br><span class="line">Loaded disassembler from /home/yuan/learn/jdk<span class="number">1.7.0_25</span>/jre/lib/amd64/hsdis-amd64.so</span><br><span class="line">Decoding compiled method <span class="number">0x00007</span>fbaec8ae2d0:</span><br><span class="line">Code:</span><br><span class="line">[Disassembling for mach='i386:x86-64']</span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; '&lt;clinit&gt;' '()V' in 'MemoryBarrierDemo'</span><br><span class="line">  #           [sp+0x20]  (sp of caller)</span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae400: sub    $0x18,%rsp         <span class="comment">;...4881ec18 000000</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae407: mov    %rbp,0x10(%rsp)    <span class="comment">;...48896c24 10</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae40c: mov    $0xebd9deb8,%r10   <span class="comment">;...49bab8de d9eb00</span></span><br><span class="line">                                                <span class="comment">;...000000</span></span><br><span class="line">                                                <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae416: mov    %r12b,0x70(%r10)   <span class="comment">;...45886270</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae41a: lock addl $0x0,(%rsp)     <span class="comment">;...f0830424 00</span></span><br><span class="line">                                                <span class="comment">;*putstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::&lt;clinit&gt;@1 (line 3)</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae41f: add    $0x10,%rsp         <span class="comment">;...4883c410</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae423: pop    %rbp               <span class="comment">;...5d</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae424: test   %eax,0x9c59bd6(%rip)        # <span class="number">0x00007</span>fbaf<span class="number">6508000</span></span><br><span class="line">                                                <span class="comment">;...8505d69b c509</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll_return&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae42a: retq                      <span class="comment">;...c3</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae42b: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae42c: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae42d: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae42e: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae42f: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae430: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae431: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae432: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae433: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae434: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae435: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae436: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae437: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae438: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae439: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae43a: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae43b: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae43c: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae43d: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae43e: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae43f: hlt                       <span class="comment">;...f4</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae440: jmpq   <span class="number">0x00007</span>fbaec80f860  <span class="comment">;...e91b14f6 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae445: callq  <span class="number">0x00007</span>fbaec8ae44a  <span class="comment">;...e8000000 00</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae44a: subq   $0x5,(%rsp)        <span class="comment">;...48832c24 05</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae44f: jmpq   <span class="number">0x00007</span>fbaec7eac00  <span class="comment">;...e9acc7f3 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae454: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae455: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae456: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8ae457: hlt                       <span class="comment">;...f4</span></span><br><span class="line">OopMapSet contains 0 OopMaps</span><br><span class="line"></span><br><span class="line">Compiled method (c2)     893  371             MemoryBarrierDemo<span class="number">::</span>main (100 bytes)</span><br><span class="line"> total in heap  [<span class="number">0x00007</span>fbaec<span class="number">8b10d0,0</span>x00007fbaec8b12b0] = 480</span><br><span class="line"> relocation     [<span class="number">0x00007</span>fbaec<span class="number">8b11f0,0</span>x00007fbaec8b1200] = 16</span><br><span class="line"> main code      [<span class="number">0x00007</span>fbaec<span class="number">8b1200,0</span>x00007fbaec8b1220] = 32</span><br><span class="line"> stub code      [<span class="number">0x00007</span>fbaec<span class="number">8b1220,0</span>x00007fbaec8b1238] = 24</span><br><span class="line"> oops           [<span class="number">0x00007</span>fbaec<span class="number">8b1238,0</span>x00007fbaec8b1240] = 8</span><br><span class="line"> scopes data    [<span class="number">0x00007</span>fbaec<span class="number">8b1240,0</span>x00007fbaec8b1258] = 24</span><br><span class="line"> scopes pcs     [<span class="number">0x00007</span>fbaec<span class="number">8b1258,0</span>x00007fbaec8b12a8] = 80</span><br><span class="line"> dependencies   [<span class="number">0x00007</span>fbaec<span class="number">8b12a8,0</span>x00007fbaec8b12b0] = 8</span><br><span class="line">Decoding compiled method <span class="number">0x00007</span>fbaec8b10d0:</span><br><span class="line">Code:</span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; 'main' '([Ljava/lang/String<span class="comment">;)V' in 'MemoryBarrierDemo'</span></span><br><span class="line">  # parm0:    rsi:rsi   = '[Ljava/lang/String<span class="comment">;'</span></span><br><span class="line">  #           [sp+0x20]  (sp of caller)</span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1200: mov    %eax,-<span class="number">0x14000</span>(%rsp)  <span class="comment">;...89842400 c0feff</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1207: push   %rbp               <span class="comment">;...55</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1208: sub    $0x10,%rsp         <span class="comment">;...4883ec10</span></span><br><span class="line">                                                <span class="comment">;*synchronization entry</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::main@-1 (line 9)</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b120c: mov    $0x3,%esi          <span class="comment">;...be030000 00</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1211: xchg   %ax,%ax            <span class="comment">;...6690</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1213: callq  <span class="number">0x00007</span>fbaec7eb020  <span class="comment">;...e8089ef3 ff</span></span><br><span class="line">                                                <span class="comment">; OopMap&#123;off=24&#125;</span></span><br><span class="line">                                                <span class="comment">;*new  ; - MemoryBarrierDemo::main@0 (line 9)</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1218: callq  <span class="number">0x00007</span>fbaf<span class="number">530f370</span>  <span class="comment">;...e853e1a5 08</span></span><br><span class="line">                                                <span class="comment">;*new  ; - MemoryBarrierDemo::main@0 (line 9)</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b121d: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b121e: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b121f: hlt                       <span class="comment">;...f4</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1220: jmpq   <span class="number">0x00007</span>fbaec80f860  <span class="comment">;...e93be6f5 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1225: callq  <span class="number">0x00007</span>fbaec8b122a  <span class="comment">;...e8000000 00</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b122a: subq   $0x5,(%rsp)        <span class="comment">;...48832c24 05</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b122f: jmpq   <span class="number">0x00007</span>fbaec7eac00  <span class="comment">;...e9cc99f3 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1234: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1235: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1236: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b1237: hlt                       <span class="comment">;...f4</span></span><br><span class="line">OopMapSet contains 1 OopMaps</span><br><span class="line"></span><br><span class="line">#0</span><br><span class="line">OopMap&#123;off=24&#125;</span><br><span class="line">Compiled method (c2)     994  398             MemoryBarrierDemo<span class="number">::acce</span>ss$000 (4 bytes)</span><br><span class="line"> total in heap  [<span class="number">0x00007</span>fbaec<span class="number">8b9390,0</span>x00007fbaec8b9578] = 488</span><br><span class="line"> relocation     [<span class="number">0x00007</span>fbaec<span class="number">8b94b0,0</span>x00007fbaec8b94c0] = 16</span><br><span class="line"> main code      [<span class="number">0x00007</span>fbaec<span class="number">8b94c0,0</span>x00007fbaec8b9500] = 64</span><br><span class="line"> stub code      [<span class="number">0x00007</span>fbaec<span class="number">8b9500,0</span>x00007fbaec8b9518] = 24</span><br><span class="line"> oops           [<span class="number">0x00007</span>fbaec<span class="number">8b9518,0</span>x00007fbaec8b9520] = 8</span><br><span class="line"> scopes data    [<span class="number">0x00007</span>fbaec<span class="number">8b9520,0</span>x00007fbaec8b9530] = 16</span><br><span class="line"> scopes pcs     [<span class="number">0x00007</span>fbaec<span class="number">8b9530,0</span>x00007fbaec8b9570] = 64</span><br><span class="line"> dependencies   [<span class="number">0x00007</span>fbaec<span class="number">8b9570,0</span>x00007fbaec8b9578] = 8</span><br><span class="line">Decoding compiled method <span class="number">0x00007</span>fbaec8b9390:</span><br><span class="line">Code:</span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; 'access$000' '()Z' in 'MemoryBarrierDemo'</span><br><span class="line">  #           [sp+0x20]  (sp of caller)</span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94c0: sub    $0x18,%rsp         <span class="comment">;...4881ec18 000000</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94c7: mov    %rbp,0x10(%rsp)    <span class="comment">;...48896c24 10</span></span><br><span class="line">                                                <span class="comment">;*synchronization entry</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@-1 (line 1)</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94cc: mov    $0xebd9deb8,%r10   <span class="comment">;...49bab8de d9eb00</span></span><br><span class="line">                                                <span class="comment">;...000000</span></span><br><span class="line">                                                <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94d6: movzbl 0x70(%r10),%eax    <span class="comment">;...410fb642 70</span></span><br><span class="line">                                                <span class="comment">;*getstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::access$000@0 (line 1)</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94db: add    $0x10,%rsp         <span class="comment">;...4883c410</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94df: pop    %rbp               <span class="comment">;...5d</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94e0: test   %eax,0x9c4eb1a(%rip)        # <span class="number">0x00007</span>fbaf<span class="number">6508000</span></span><br><span class="line">                                                <span class="comment">;...85051aeb c409</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll_return&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94e6: retq                      <span class="comment">;...c3</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94e7: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94e8: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94e9: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94ea: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94eb: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94ec: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94ed: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94ee: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94ef: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f0: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f1: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f2: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f3: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f4: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f5: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f6: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f7: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f8: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94f9: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94fa: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94fb: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94fc: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94fd: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94fe: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b94ff: hlt                       <span class="comment">;...f4</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec8b9500: jmpq   <span class="number">0x00007</span>fbaec80f860  <span class="comment">;...e95b63f5 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec8b9505: callq  <span class="number">0x00007</span>fbaec8b950a  <span class="comment">;...e8000000 00</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b950a: subq   $0x5,(%rsp)        <span class="comment">;...48832c24 05</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b950f: jmpq   <span class="number">0x00007</span>fbaec7eac00  <span class="comment">;...e9ec16f3 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b9514: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b9515: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b9516: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec8b9517: hlt                       <span class="comment">;...f4</span></span><br><span class="line">OopMapSet contains 0 OopMaps</span><br><span class="line"></span><br><span class="line">OS: Linux amd64</span><br><span class="line">JavaVersion: <span class="number">1.7.0_25</span></span><br><span class="line"></span><br><span class="line">Compiled method (c2)    3101  428             MemoryBarrierDemo<span class="number">::</span>setCancel (5 bytes)</span><br><span class="line"> total in heap  [<span class="number">0x00007</span>fbaec<span class="number">896b90,0</span>x00007fbaec896d60] = 464</span><br><span class="line"> relocation     [<span class="number">0x00007</span>fbaec896cb<span class="number">0,0x00007</span>fbaec896cc0] = 16</span><br><span class="line"> main code      [<span class="number">0x00007</span>fbaec896cc<span class="number">0,0x00007</span>fbaec896d00] = 64</span><br><span class="line"> stub code      [<span class="number">0x00007</span>fbaec<span class="number">896d00,0</span>x00007fbaec896d18] = 24</span><br><span class="line"> oops           [<span class="number">0x00007</span>fbaec<span class="number">896d18,0</span>x00007fbaec896d20] = 8</span><br><span class="line"> scopes data    [<span class="number">0x00007</span>fbaec<span class="number">896d20,0</span>x00007fbaec896d28] = 8</span><br><span class="line"> scopes pcs     [<span class="number">0x00007</span>fbaec<span class="number">896d28,0</span>x00007fbaec896d58] = 48</span><br><span class="line"> dependencies   [<span class="number">0x00007</span>fbaec<span class="number">896d58,0</span>x00007fbaec896d60] = 8</span><br><span class="line">Decoding compiled method <span class="number">0x00007</span>fbaec896b90:</span><br><span class="line">Code:</span><br><span class="line">[Entry Point]</span><br><span class="line">[Verified Entry Point]</span><br><span class="line">[Constants]</span><br><span class="line">  # &#123;method&#125; 'setCancel' '()V' in 'MemoryBarrierDemo'</span><br><span class="line">  #           [sp+0x20]  (sp of caller)</span><br><span class="line">  <span class="number">0x00007</span>fbaec896cc0: sub    $0x18,%rsp         <span class="comment">;...4881ec18 000000</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cc7: mov    %rbp,0x10(%rsp)    <span class="comment">;...48896c24 10</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896ccc: mov    $0xebd9deb8,%r10   <span class="comment">;...49bab8de d9eb00</span></span><br><span class="line">                                                <span class="comment">;...000000</span></span><br><span class="line">                                                <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cd6: movb   $<span class="number">0x1,0x70</span>(%r10)    <span class="comment">;...41c64270 01</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cdb: lock addl $0x0,(%rsp)     <span class="comment">;...f0830424 00</span></span><br><span class="line">                                                <span class="comment">;*putstatic cancel</span></span><br><span class="line">                                                <span class="comment">; - MemoryBarrierDemo::setCancel@1 (line 5)</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896ce0: add    $0x10,%rsp         <span class="comment">;...4883c410</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896ce4: pop    %rbp               <span class="comment">;...5d</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896ce5: test   %eax,<span class="number">0x9c71315</span>(%rip)        # <span class="number">0x00007</span>fbaf<span class="number">6508000</span></span><br><span class="line">                                                <span class="comment">;...85051513 c709</span></span><br><span class="line">                                                <span class="comment">;   &#123;poll_return&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896ceb: retq                      <span class="comment">;...c3</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cec: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896ced: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cee: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cef: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf0: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf1: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf2: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf3: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf4: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf5: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf6: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf7: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf8: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cf9: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cfa: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cfb: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cfc: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cfd: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cfe: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896cff: hlt                       <span class="comment">;...f4</span></span><br><span class="line">[Exception Handler]</span><br><span class="line">[Stub Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec896d00: jmpq   <span class="number">0x00007</span>fbaec80f860  <span class="comment">;...e95b8bf7 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;no_reloc&#125;</span></span><br><span class="line">[Deopt Handler Code]</span><br><span class="line">  <span class="number">0x00007</span>fbaec896d05: callq  <span class="number">0x00007</span>fbaec896d0a  <span class="comment">;...e8000000 00</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896d0a: subq   $0x5,(%rsp)        <span class="comment">;...48832c24 05</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896d0f: jmpq   <span class="number">0x00007</span>fbaec7eac00  <span class="comment">;...e9ec3ef5 ff</span></span><br><span class="line">                                                <span class="comment">;   &#123;runtime_call&#125;</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896d14: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896d15: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896d16: hlt                       <span class="comment">;...f4</span></span><br><span class="line">  <span class="number">0x00007</span>fbaec896d17: hlt                       <span class="comment">;...f4</span></span><br><span class="line">OopMapSet contains 0 OopMaps</span><br><span class="line"></span><br><span class="line">flag cancel set to true</span><br><span class="line">Done!</span><br><span class="line">yuan@yuan-HP:~/learn$</span><br></pre></td></tr></table></figure>
<p>摘出我们所关心的部分：</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00007</span>fbaec896ccc: mov    $0xebd9deb8,%r10   <span class="comment">;...49bab8de d9eb00</span></span><br><span class="line">                                              <span class="comment">;...000000</span></span><br><span class="line">                                              <span class="comment">;   &#123;oop(a 'java/lang/Class' = 'MemoryBarrierDemo')&#125;</span></span><br><span class="line"><span class="number">0x00007</span>fbaec896cd6: movb   $<span class="number">0x1,0x70</span>(%r10)    <span class="comment">;...41c64270 01</span></span><br><span class="line"><span class="number">0x00007</span>fbaec896cdb: lock addl $0x0,(%rsp)     <span class="comment">;...f0830424 00</span></span><br></pre></td></tr></table></figure>
<p>在<code>movb   $0x1,0x70(%r10)</code>将<code>cancel</code>设为<code>true</code>之后有一行带有LOCK语义的代码，这就与笔者推理的一致了^_^。</p>
<p>（在这里还有一个让笔者困惑的地方：对于没有volatile的版本，如果执行的时候加了<code>-Xcomp</code>，程序同样可以正常退出，程序行为与加了volatile的版本一致，但是汇编代码中到LOCK。笔者对于JIT完全不懂，所以也只能暂且存疑啦。）</p>
<p>再回过头来整理一下思路。在笔者提供的例子主要是因为没有遵守Java Memory Model，编译器为了性能而做出的优化造成程序无法终止。这其实也不是笔者想要看到的结果，但是通过读_Intel 64 and IA-32 Architectures Software Developer’s Manual Combined Volumes 3A, 3B, and 3C: System Programming Guide_解开了笔者心中的疑惑。</p>
<p>让笔者产生困惑的地方是buffer。</p>
<h2 id="buffer">Buffer</h2>
<p>笔者之前头脑中的CPU模型大概是这样：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">+-------------------+</span></span><br><span class="line"><span class="header">| Memory Controller |</span><br><span class="line">+-------------------+</span></span><br><span class="line"><span class="header">        |</span><br><span class="line">+---------------------------------------------------------------+</span></span><br><span class="line"><span class="header">| L3                                                            |</span><br><span class="line">+---------------------------------------------------------------+</span></span><br><span class="line"><span class="code">        |                        |</span></span><br><span class="line"><span class="code">+-----------------+</span>      <span class="code">+-----------------+</span></span><br><span class="line">| L1 L2           |      | L1 L2           |    ...</span><br><span class="line"><span class="code">+-----------------+</span>      <span class="code">+-----------------+</span></span><br><span class="line"><span class="code">        |                        |</span></span><br><span class="line"><span class="code">+-----------------+</span>      <span class="code">+-----------------+</span></span><br><span class="line">| Execution Units |      | Execution Units |    ...</span><br><span class="line"><span class="code">+-----------------+</span>      <span class="code">+-----------------+</span></span><br></pre></td></tr></table></figure>
<p>从执行单元进入L1或L2 cache之后就是cache coherency protocol控制的“天下”了，其它的core肯定就会“看到”相应的改变，怎么还会“看不到”相应的改变呢？这就是让笔者一直困惑的地方。（关于cache coherency，请看<em>支撑处理器的技术</em>的第5.2节）</p>
<p>实际上现代的CPU在执行单元与L1、L2之间还存在Load Buffer、Store Buffer和WCBuffers。它们存在的原因？可想而知是为了弥补执行单元与缓存之间的速度差异，比如<a href="http://mechanical-sympathy.blogspot.com/2011/07/write-combining.html" target="_blank" rel="external">Write Combining</a>技术。对于这三个buffer，x86指令集中有三个细粒度的指令LFENCE、SFENCE和MFENCE控制，在前面所看到的LOCK等同于MFENCE。</p>
<p>在<em>Intel 64 and IA-32 Architectures Software Developer’s Manual Combined Volumes 3A, 3B, and 3C: System Programming Guide</em>的第8-16页：</p>
<blockquote>
<p>The SFENCE, LFENCE, and MFENCE instructions provide a performance-efficient way of ensuring load and store memory ordering between routines that produce weakly-ord ered results and routines that consume that data. The functions of these instructions are as follows:</p>
</blockquote>
<blockquote>
<ul>
<li>SFENCE — Serializes all store (write) operations that occu rred prior to the SFENCE instruction in the program instruction stream, but does not affect load operations.</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>LFENCE — Serializes all load (read) operations that occurred prior to the LFENCE instruction in the program instruction stream, but does not affect store operations.</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li>MFENCE — Serializes all store and load operations that occurred prior to the MFENCE instruction in the program instruction stream.</li>
</ul>
</blockquote>
<p>关于这三个指令与Java语言的关系，请看<a href="http://mechanical-sympathy.blogspot.com/2011/07/memory-barriersfences.html" target="_blank" rel="external">Memory Barriers/Fences</a>。这篇文章中还提到了Out of Order的影响，所以本文就不再重复了。</p>
<h2 id="总结">总结</h2>
<ol style="list-style-type: decimal">
<li><p>CPU的“人生价值”就是尽可能的快！为此可以不择手段，比如Write Combining和Out of Order；但是它也提供了LOCK、XCHG、LFENCE、SFENCE、MFENCE等指令满足上层软件同步的需求。</p></li>
<li><p>同步要以牺牲性能为代价。JVM会尽可能优化性能，如果要实现必要的同步就得遵守Java Memory Model，在程序中显式的使用相关机制。</p></li>
<li><p>“Shared mutability is pure evil”（引自_Programming Concurrency on the JVM_）。如果不是legacy系统，笔者肯定优先考虑Actor-based Model。</p></li>
</ol>
	  
	</div>

	<div>
  	<center>
	<div class="pagination">
<ul class="pagination">
	 
				
    	<li class="prev"><a href="/2013/09/19/java_object_in_memory/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i>上一頁</a></li>
  		

        <li><a href="/archives"><i class="fa fa-archive"></i>Archive</a></li>

		
		   <li class="next"><a href="/2013/08/07/disruptor5/" class="alignright next">下一頁<i class="fa fa-arrow-circle-o-right"></i></a></li>         
        
	
</ul>
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
  <h2 class="title">留言</h2>

  
</section>

	
	</div> <!-- col-md-9/col-md-12 -->
	
	
		<div class="col-md-3"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2013-08-10 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/concurrency/">concurrency<span>3</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	

</div><!-- row -->

	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2015 Shichao Yuan
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>





<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
