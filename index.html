<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Notes</title>
  <meta name="author" content="Shichao Yuan">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="Notes"/>

  
    <meta property="og:image" content="undefined"/>
  

  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  



</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Notes</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="page-header">
  <h1>Notes</h1>
</div>

<div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Stay Hungry, Stay Foolish.
</div>    

		<div class="mypage">
		
		<!-- title and entry -->
		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-08-06 </div>
			<div class="article-title"><a href="/2015/08/06/startup-web-playframework/" >如何快速开始一个小项目 —— playframework</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h2 id="section">1</h2>
<p>基本文档 <a href="https://www.playframework.com/documentation/2.4.x/Home" target="_blank" rel="external">Play 2.4.x documentation</a></p>
<h2 id="section-1">2</h2>
<p>生成框架 <a href="https://www.playframework.com/documentation/2.4.x/NewApplication" target="_blank" rel="external">Creating a new application</a></p>
<p>导入Eclipse <a href="https://www.playframework.com/documentation/2.4.x/IDE#Eclipse" target="_blank" rel="external">Setting up your preferred IDE</a></p>
<p><strong>NOTE</strong> 目前<code>Scala IDE</code>的4.1.1版本的play plugin有问题，可以暂时自行编译安装<a href="https://github.com/cweinreben/scala-ide-play2" class="uri" target="_blank" rel="external">https://github.com/cweinreben/scala-ide-play2</a>这个fork。</p>
<h2 id="section-2">3</h2>
<p>连接数据库</p>
<p><a href="http://slick.typesafe.com/" target="_blank" rel="external"><strong>Slick</strong></a></p>
<p>用于连接MySQL，详见文档<a href="https://www.playframework.com/documentation/2.4.x/PlaySlick" target="_blank" rel="external">PlaySlick</a></p>
<p><a href="http://reactivemongo.org/" target="_blank" rel="external"><strong>ReactiveMongo</strong></a></p>
<p>用于连接MongoDB，详见文档<a href="http://reactivemongo.org/releases/0.11/documentation/tutorial/play2.html" target="_blank" rel="external">Reactive Scala Driver for MongoDB</a></p>
<h2 id="section-3">4</h2>
<p>Log</p>
<p>基本上就是配置logback</p>
<p><a href="https://www.playframework.com/documentation/2.4.x/SettingsLogger" target="_blank" rel="external">Configuring logging</a></p>
<p><a href="https://www.playframework.com/documentation/2.4.x/ScalaLogging" target="_blank" rel="external">The Logging API</a></p>
<p>文档中还很贴心的给出了两种实现accesslog的方法。</p>
<h2 id="section-4">5</h2>
<p>部署服务</p>
<p><a href="https://www.playframework.com/documentation/2.4.x/Production" target="_blank" rel="external">Deploying your application</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/08/06/startup-web-playframework/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-08-05 </div>
			<div class="article-title"><a href="/2015/08/05/startup-web-spring/" >如何快速开始一个小项目 —— spring-boot</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>最近帮朋友搭了一些小东东，用得都是开源的东东，感觉都还挺方便，基本上稍微配置一下就可以开始一个小项目。</p>
<p>所以简单记一下。</p>
<p>这篇记录spring-boot</p>
<h2 id="section">1</h2>
<p>基本的框架：<a href="http://spring.io/guides/gs/rest-service/" target="_blank" rel="external">Building a RESTful Web Service</a></p>
<p>基本的文档：<a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/" target="_blank" rel="external">Spring Boot Reference Guide</a></p>
<h2 id="section-1">2</h2>
<p>连接MySQL</p>
<p><code>pom.xml</code></p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">spring</span>-boot-starter-<span class="typedef"><span class="keyword">data</span>-jpa</span></span><br><span class="line"><span class="title">mysql</span>-connector-java //不要漏了</span><br></pre></td></tr></table></figure>
<p><code>application.properties</code></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring<span class="class">.datasource</span><span class="class">.url</span>=jdbc:mysql:<span class="comment">//localhost/xxx</span></span><br><span class="line">spring<span class="class">.datasource</span><span class="class">.username</span>=xxx</span><br><span class="line">spring<span class="class">.datasource</span><span class="class">.password</span>=xxx</span><br><span class="line">spring<span class="class">.datasource</span><span class="class">.driver-class-name</span>=com<span class="class">.mysql</span><span class="class">.jdbc</span><span class="class">.Driver</span></span><br></pre></td></tr></table></figure>
<p>一些annotation</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@Query</span>(<span class="string">"select u from User u where u.email = ?1 "</span>)</span><br><span class="line"></span><br><span class="line"><span class="annotation">@Transactional</span>(rollbackFor=RuntimeException.class)</span><br></pre></td></tr></table></figure>
<h2 id="section-2">3</h2>
<p>处理异常以及返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@ExceptionHandler</span>(&#123; UnAuthenticationException.class &#125;)</span><br><span class="line">	<span class="annotation">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;?&gt; handleUnauthenticationException(Exception e) &#123;</span><br><span class="line">		<span class="keyword">return</span> errorResponse(e, HttpStatus.UNAUTHORIZED);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="annotation">@ExceptionHandler</span>(&#123; Exception.class &#125;)</span><br><span class="line">	<span class="annotation">@ResponseBody</span></span><br><span class="line">	<span class="keyword">public</span> ResponseEntity&lt;?&gt; handleAnyException(Exception e) &#123;</span><br><span class="line">		<span class="keyword">return</span> errorResponse(e, HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> ResponseEntity&lt;Result&gt; <span class="title">errorResponse</span><span class="params">(Throwable throwable, HttpStatus status)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> != throwable) &#123;</span><br><span class="line">			<span class="keyword">return</span> response(<span class="keyword">new</span> Result(<span class="keyword">new</span> Meta(status.value(), throwable.getMessage())), status);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> response(<span class="keyword">new</span> Result(<span class="keyword">new</span> Meta(status.value(), <span class="string">""</span>)), status);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> &lt;T&gt; <span class="function">ResponseEntity&lt;T&gt; <span class="title">response</span><span class="params">(T body, HttpStatus status)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;T&gt;(body, <span class="keyword">new</span> HttpHeaders(), status);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理JSON</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="annotation">@JsonInclude</span>(Include.NON_NULL)</span><br><span class="line"><span class="annotation">@JsonIgnore</span></span><br></pre></td></tr></table></figure>
<h2 id="section-3">4</h2>
<p>日志</p>
<p><code>application.properties</code></p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">logging.<span class="keyword">file</span>=xxx.<span class="literal">log</span></span><br><span class="line">logging.path=/<span class="keyword">var</span>/<span class="literal">log</span></span><br></pre></td></tr></table></figure>
<p>或者自定义<code>logback.xml</code>文件</p>
<p>比较全的<code>application.properties</code>例子见<a href="http://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html" target="_blank" rel="external">文档</a></p>
<p>例如，access log</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server.tomcat.<span class="keyword">access</span>-<span class="built_in">log</span>-pattern= # <span class="built_in">log</span> pattern of the <span class="keyword">access</span> <span class="built_in">log</span></span><br><span class="line">server.tomcat.<span class="keyword">access</span>-<span class="built_in">log</span>-enabled=false # is <span class="keyword">access</span> logging enabled</span><br></pre></td></tr></table></figure>
<h2 id="section-4">5</h2>
<p>Interceptor</p>
<p><a href="http://www.concretepage.com/spring/spring-mvc/spring-handlerinterceptor-annotation-example-webmvcconfigureradapter" target="_blank" rel="external">Spring MVC HandlerInterceptor Annotation Example with WebMvcConfigurerAdapter</a></p>
<p>这篇文章写得蛮清楚的，唯一需要注意的是：<a href="http://stackoverflow.com/questions/31082981/spring-boot-adding-http-request-interceptors" target="_blank" rel="external">do not annotate this with EnableWebMvc, if you want to keep Spring Boots auto configuration for mvc</a></p>
<h2 id="section-5">6</h2>
<p>未完待续</p>
<h2 id="section-6">0</h2>
<p>一些好用的三方库</p>
<ol style="list-style-type: decimal">
<li>PBKDF2 <a href="https://github.com/qaware/heimdall" target="_blank" rel="external">heimdall</a></li>
<li>JWT <a href="https://github.com/auth0/java-jwt" target="_blank" rel="external">java-jwt</a></li>
</ol>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/08/05/startup-web-spring/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-07-10 </div>
			<div class="article-title"><a href="/2015/07/10/notes-pepfcp/" >Reading Notes - Prudent Engineering Practice for Cryptographic Protocols</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h2 id="section">1</h2>
<p>最近在做一个关于支付的小需求，其中有个关于支付密码的地方，由于运维短时间内提供不了HTTPS，所以需要设计一个简单的加密协议，保证密码不能泄露，不能被重放攻击。</p>
<p>如何做？</p>
<p>使用RSA算法，客户端内置一个公钥（或者动态获取），服务器保存一个私钥，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1. server -------------nonce-----------&#62; client&#10;2. server &#60;---encrypt(passowrd+nonce)--- client&#10;&#10;server decrypt(message) and check(password+nonce)</span><br></pre></td></tr></table></figure>
<p>当然密码存储不当也存在泄露的问题，解决这个问题可以使用PBKDF2(<a href="https://tools.ietf.org/html/rfc2898" target="_blank" rel="external">rfc2898</a>)。至于迭代次数可以参考stackexchange中的这个<a href="http://security.stackexchange.com/questions/3959/recommended-of-iterations-when-using-pkbdf2-sha256" target="_blank" rel="external">问题</a>。</p>
<p>另外终端安全坑太大，暂时不考虑。</p>
<p>然后又想起读书的时候上《安全协议》那门课读的那些论文，其中有一篇感觉相当经典，所以又找出来读了一遍。</p>
<h2 id="section-1">2</h2>
<p><a href="http://ieeexplore.ieee.org/xpl/articleDetails.jsp?arnumber=481513&amp;filter%3DAND%28p_IS_Number%3A10294%29" target="_blank" rel="external">Prudent Engineering Practice for Cryptographic Protocols</a></p>
<h3 id="principle-1">Principle 1</h3>
<blockquote>
<p>Every message should say what it means: the interpretation of the message should depend only on its content. It should be possible to write down a straightforward English sentence describing the content – though if there is a suitable formalism available that is good too.</p>
</blockquote>
<h3 id="principle-2">Principle 2</h3>
<blockquote>
<p>The conditions for a message to be acted upon should be clearly set out so that someone reviewing a design may see whether they are acceptable or not.</p>
</blockquote>
<h3 id="principle-3">Principle 3</h3>
<blockquote>
<p>If the identity of a principal is essential to the meaning of a message, it is prudent to mention the principal’s name explicitly in the message.</p>
</blockquote>
<h3 id="principle-4">Principle 4</h3>
<blockquote>
<p>Be clear as to why encryption is being done. Encryption is not wholly cheap, and not asking precisely why it is being done can lead to redundancy. Encryption is not synonymous with security, and its improper use can lead to errors. ###Principle 5 When a principal signs material that has already been encrypted, it should not be inferred that the principal knows the content of the message. On the other hand, it is proper to infer that the principal that signs a message and then encrypts it for privacy knows the content of the message.</p>
</blockquote>
<h3 id="principle-6">Principle 6</h3>
<blockquote>
<p>Be clear what properties you are assuming about nonces. What may do for ensuring temporal succession may not do for ensuring association – and perhaps association is best established by other means.</p>
</blockquote>
<h3 id="principle-7">Principle 7</h3>
<blockquote>
<p>The use of a predictable quantity (such as the value of a counter) can serve in guaranteeing newness, through a challenge-response exchange. But if a predictable quantity is to be effective, it should be protected so that an intruder cannot simulate a challenge and later replay a response.</p>
</blockquote>
<h3 id="principle-8">Principle 8</h3>
<blockquote>
<p>If timestamps are used as freshness guarantees by reference to absolute time, then the difference between local clocks at various machines must be much less than the allowable age of a message deemed to be valid. Furthermore, the time maintenance mechanism everywhere becomes part of the trusted computing base.</p>
</blockquote>
<h3 id="principle-9">Principle 9</h3>
<blockquote>
<p>A key may have been used recently, for example to encrypt a nonce, yet be quite old, and possibly compromised. Recent use does not make the key look any better than it would otherwise.</p>
</blockquote>
<h3 id="principle-10">Principle 10</h3>
<blockquote>
<p>If an encoding is used to present the meaning of a message, then it should be possible to tell which encoding is being used. In the common case where the encoding is protocol dependent, it should be possible to deduce that the message belongs to this protocol, and in fact to a particular run of the protocol, and to know its number in the protocol.</p>
</blockquote>
<h3 id="principle-11">Principle 11</h3>
<blockquote>
<p>The protocol designer should know which trust relations his protocol depends on, and why the dependence is necessary. The reasons for particular trust relations being acceptable should be explicit though they will be founded on judgement and policy rather than on logic.</p>
</blockquote>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/07/10/notes-pepfcp/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-06-30 </div>
			<div class="article-title"><a href="/2015/06/30/weak-reference/" >weak reference</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h2 id="section">1</h2>
<p>最近看了一篇文章<a href="http://www.javaspecialists.eu/archive/Issue164.html" target="_blank" rel="external">Why 0x61c88647?</a>，感觉写的很细致。</p>
<p>关于<code>ThreadLocal</code>的问题，这里就不复述了。</p>
<p>文章在讲解<code>ThreadLocal</code>的实现的时候，提到了<code>WeakReference</code>。</p>
<p>感觉还是挺陌生的，印象中在用<code>Guava</code>的<code>Cache</code>的时候遇到过设置<code>key</code>和<code>value</code>为<code>weak</code>状态。（不过使用的时候也没配置过相关的选项……）</p>
<p>大致了解是跟GC有关系，其它就不清楚了，所以就多google一下吧。</p>
<h2 id="section-1">2</h2>
<p><a href="https://weblogs.java.net/blog/2006/05/04/understanding-weak-references" target="_blank" rel="external">Understanding Weak References</a></p>
<p>找到这篇文章，感觉介绍的挺直观。</p>
<p>简单总结一下：</p>
<p>通常的Java引用是strong reference。但是对于有些场景，比如做为缓存的<code>Map</code>，需要维护增减的键值，就有点类似于手动地分配、释放内存，这就失去自动垃圾回收的优势了嘛。</p>
<p>所以就可以使用<code>WeakHashMap</code>，其中的键是弱引用的，GC就可以回收到，顺便值也自动回收了。</p>
<p>另外，“弱”的程度：</p>
<p>Soft references：weak和strong是发现了就回收，而soft得等等。</p>
<p>Phantom references：感觉使用场景想不太到。</p>
<h2 id="section-2">3</h2>
<p>看一下<code>WeakHashMap</code>的实现吧~</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeakHashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span><br><span class="line">    <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span><br><span class="line">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The table, resized as necessary. Length MUST Always be a power of two.</span><br><span class="line">     */</span></span><br><span class="line">    Entry&lt;K,V&gt;[] table;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Reference queue for cleared WeakEntries</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; queue = <span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Associates the specified value with the specified key in this map.</span><br><span class="line">     * If the map previously contained a mapping for this key, the old</span><br><span class="line">     * value is replaced.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@param</span> key key with which the specified value is to be associated.</span><br><span class="line">     * <span class="doctag">@param</span> value value to be associated with the specified key.</span><br><span class="line">     * <span class="doctag">@return</span> the previous value associated with &lt;tt&gt;key&lt;/tt&gt;, or</span><br><span class="line">     *         &lt;tt&gt;null&lt;/tt&gt; if there was no mapping for &lt;tt&gt;key&lt;/tt&gt;.</span><br><span class="line">     *         (A &lt;tt&gt;null&lt;/tt&gt; return can also indicate that the map</span><br><span class="line">     *         previously associated &lt;tt&gt;null&lt;/tt&gt; with &lt;tt&gt;key&lt;/tt&gt;.)</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        Object k = maskNull(key);</span><br><span class="line">        <span class="keyword">int</span> h = hash(k);</span><br><span class="line">        Entry&lt;K,V&gt;[] tab = getTable();</span><br><span class="line">        <span class="keyword">int</span> i = indexFor(h, tab.length);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            <span class="keyword">if</span> (h == e.hash &amp;&amp; eq(k, e.get())) &#123;</span><br><span class="line">                V oldValue = e.value;</span><br><span class="line">                <span class="keyword">if</span> (value != oldValue)</span><br><span class="line">                    e.value = value;</span><br><span class="line">                <span class="keyword">return</span> oldValue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        modCount++;</span><br><span class="line">        Entry&lt;K,V&gt; e = tab[i];</span><br><span class="line">        tab[i] = <span class="keyword">new</span> Entry&lt;&gt;(k, value, queue, h, e);</span><br><span class="line">        <span class="keyword">if</span> (++size &gt;= threshold)</span><br><span class="line">            resize(tab.length * <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns the value to which the specified key is mapped,</span><br><span class="line">     * or &#123;<span class="doctag">@code</span> null&#125; if this map contains no mapping for the key.</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;More formally, if this map contains a mapping from a key</span><br><span class="line">     * &#123;<span class="doctag">@code</span> k&#125; to a value &#123;<span class="doctag">@code</span> v&#125; such that &#123;<span class="doctag">@code</span> (key==null ? k==null :</span><br><span class="line">     * key.equals(k))&#125;, then this method returns &#123;<span class="doctag">@code</span> v&#125;; otherwise</span><br><span class="line">     * it returns &#123;<span class="doctag">@code</span> null&#125;.  (There can be at most one such mapping.)</span><br><span class="line">     *</span><br><span class="line">     * &lt;p&gt;A return value of &#123;<span class="doctag">@code</span> null&#125; does not &lt;i&gt;necessarily&lt;/i&gt;</span><br><span class="line">     * indicate that the map contains no mapping for the key; it's also</span><br><span class="line">     * possible that the map explicitly maps the key to &#123;<span class="doctag">@code</span> null&#125;.</span><br><span class="line">     * The &#123;<span class="doctag">@link</span> #containsKey containsKey&#125; operation may be used to</span><br><span class="line">     * distinguish these two cases.</span><br><span class="line">     *</span><br><span class="line">     * <span class="doctag">@see</span> #put(Object, Object)</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">        Object k = maskNull(key);</span><br><span class="line">        <span class="keyword">int</span> h = hash(k);</span><br><span class="line">        Entry&lt;K,V&gt;[] tab = getTable();</span><br><span class="line">        <span class="keyword">int</span> index = indexFor(h, tab.length);</span><br><span class="line">        Entry&lt;K,V&gt; e = tab[index];</span><br><span class="line">        <span class="keyword">while</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp; eq(k, e.get()))</span><br><span class="line">                <span class="keyword">return</span> e.value;</span><br><span class="line">            e = e.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Returns the table after first expunging stale entries.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> Entry&lt;K,V&gt;[] getTable() &#123;</span><br><span class="line">        expungeStaleEntries();</span><br><span class="line">        <span class="keyword">return</span> table;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * Expunges stale entries from the table.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expungeStaleEntries</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (Object x; (x = queue.poll()) != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (queue) &#123;</span><br><span class="line">                <span class="annotation">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">                    Entry&lt;K,V&gt; e = (Entry&lt;K,V&gt;) x;</span><br><span class="line">                <span class="keyword">int</span> i = indexFor(e.hash, table.length);</span><br><span class="line"></span><br><span class="line">                Entry&lt;K,V&gt; prev = table[i];</span><br><span class="line">                Entry&lt;K,V&gt; p = prev;</span><br><span class="line">                <span class="keyword">while</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    Entry&lt;K,V&gt; next = p.next;</span><br><span class="line">                    <span class="keyword">if</span> (p == e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (prev == e)</span><br><span class="line">                            table[i] = next;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            prev.next = next;</span><br><span class="line">                        <span class="comment">// Must not null out e.next;</span></span><br><span class="line">                        <span class="comment">// stale entries may be in use by a HashIterator</span></span><br><span class="line">                        e.value = <span class="keyword">null</span>; <span class="comment">// Help GC</span></span><br><span class="line">                        size--;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    prev = p;</span><br><span class="line">                    p = next;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span><br><span class="line">     * The entries in this hash table extend WeakReference, using its main ref</span><br><span class="line">     * field as the key.</span><br><span class="line">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">WeakReference</span>&lt;<span class="title">Object</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">        V value;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">        Entry&lt;K,V&gt; next;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/**</span><br><span class="line">         * Creates new entry.</span><br><span class="line">         */</span></span><br><span class="line">        Entry(Object key, V value,</span><br><span class="line">              ReferenceQueue&lt;Object&gt; queue,</span><br><span class="line">              <span class="keyword">int</span> hash, Entry&lt;K,V&gt; next) &#123;</span><br><span class="line">            <span class="keyword">super</span>(key, queue);</span><br><span class="line">            <span class="keyword">this</span>.value = value;</span><br><span class="line">            <span class="keyword">this</span>.hash  = hash;</span><br><span class="line">            <span class="keyword">this</span>.next  = next;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>逻辑非常清楚——一个通过链接法解决冲突的散列表。</p>
<p>其中有两个地方比较关键：</p>
<p>第一个，<code>Entity</code>的构造方法，传入了<code>ReferenceQueue</code>，这样当某个<code>WeakReference</code>被回收的时候将会进入队列；</p>
<p>第二个，<code>expungeStaleEntries()</code>，清除散列表中被回收的key，同时将value设为空（这个对GC帮助很大呀）。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/06/30/weak-reference/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-06-15 </div>
			<div class="article-title"><a href="/2015/06/15/link_prediction_problem/" >Link Prediction Problem</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h2 id="section">1</h2>
<p>最近在看一些好友推荐的东西，所以就多google了一下。</p>
<p>看到一篇论文<a href="http://www.cs.cornell.edu/home/kleinber/link-pred.pdf" target="_blank" rel="external">《The Link Prediction Problem for Social Networks》</a>，感觉写的很不错。</p>
<p>（对这种形式化的描述没抵抗力 :-D）</p>
<p>所以就是做个笔记吧。</p>
<h2 id="section-1">2</h2>
<p>首先<em>social networks</em>可以理解为图，其中<em>nodes</em>表示人或者其他实体，<em>edges</em>标示交互、协作或者关系。</p>
<p>那么好友推荐的问题就可以理解为基于原有的好友关系图结构，预测可能出现的新的关系。</p>
<p>更一般的，可以理解为<em>link prediction problem</em>，基于原有的图结构，预测图的演化。</p>
<blockquote>
<p>the <em>link prediction problem</em>：</p>
<p>Given a snapshot of a social network at time <em>t</em>, we seek to accurately predict the edges that will be added to the network during the interval from time <span class="math inline">\(t\)</span> to a given future time <span class="math inline">\(t&#39;\)</span>.</p>
</blockquote>
<p>当然现实中的交互和关系有很多原因，单单从图结构中是分析不出来的。</p>
<p>但是</p>
<blockquote>
<p>We find that a number of proximity measures lead to predictions that outperform chance by factors of 40 to 50, indicating that the network topology does indeed contain latent information from which to infer future interactions.</p>
</blockquote>
<p>（是这样么？ 暂且相信一下吧，不然就没法继续读下去了 :-D）</p>
<h2 id="section-2">3</h2>
<p>形式化这个问题。</p>
<p>social network: <span class="math inline">\(G = \langle V, E \rangle\)</span></p>
<p>each edge: <span class="math inline">\(e = \langle u, v \rangle \in E\)</span></p>
<p>表示<span class="math inline">\(u,v\)</span>在特定时间<span class="math inline">\(t(e)\)</span>发生交互，其中多次交互记录为并行的边。</p>
<p><span class="math inline">\(G[t, t&#39;]\)</span>表示某时间段内<span class="math inline">\((t &lt; t&#39;)\)</span>的子图。</p>
<p>另外这篇文章为了评估不同的算法还是定义训练和测试的方法：</p>
<blockquote>
<p>We choose four times <span class="math inline">\(t_0 &lt; t&#39;_0 &lt; t_1 &lt; t&#39;_1\)</span>, and give an algorithm access to the network <span class="math inline">\(G[t_0,t&#39;_0]\)</span>; it must then output a list of edges, not present in <span class="math inline">\(G[t_0,t&#39;_0]\)</span>, that are predicted to appear in the network <span class="math inline">\(G[t_1,t&#39;_1]\)</span>. We refer to <span class="math inline">\([t_0,t&#39;_0]\)</span> as the <em>training interval</em> and <span class="math inline">\([t_1,t&#39;_1]\)</span> as the <em>test interval</em>.</p>
<p>Thus, in evaluating link prediction methods, we will generally use two parameters <span class="math inline">\(\mit{κ_{training}}\)</span> and <span class="math inline">\(\mit{κ_{test}}\)</span> (each set to 3 below), and define the set <strong>Core</strong> to be all nodes incident to at least <span class="math inline">\(\mit{κ_{training}}\)</span> edges in <span class="math inline">\(G[t_0, t&#39;_0]\)</span> and at least <span class="math inline">\(\mit{κ_{test}}\)</span> edges in <span class="math inline">\(G[t_1,t&#39;_1]\)</span>. We will then evaluate how accurately the new edges between elements of <strong>Core</strong> can be predicted.</p>
<p>We define the training interval to be the three years <span class="math inline">\([1994, 1996]\)</span>, and the test interval to be <span class="math inline">\([1997, 1999]\)</span>. We denote the subgraph <span class="math inline">\(G[1994, 1996]\)</span> on the training interval by $G_{collab} := A, E_{old} $, and use <span class="math inline">\(E_{new}\)</span> to denote the set of edges <span class="math inline">\(\langle u, v \rangle\)</span> such that <span class="math inline">\(u, v \in A\)</span>, and <span class="math inline">\(u, v\)</span> co-author a paper during the test interval but not the training interval – these are the new interactions we are seeking to predict.</p>
</blockquote>
<p>评估的方法如下：</p>
<blockquote>
<p>Each link predictor <span class="math inline">\(p\)</span> that we consider outputs a ranked list <span class="math inline">\(L_p\)</span> of pairs in <span class="math inline">\(A×A−E_{old}\)</span>; these are predicted new collaborations, in decreasing order of confidence. For our evaluation, we focus on the set <strong>Core</strong>, so we define <span class="math inline">\(E^∗_{new} := E_{new} \cap (Core \times Core)\)</span> and <span class="math inline">\(n := |E^∗_{new}|\)</span>. Our performance measure for predictor <span class="math inline">\(p\)</span> is then determined as follows: from the ranked list <span class="math inline">\(L_p\)</span>, we take the first <span class="math inline">\(n\)</span> pairs in <span class="math inline">\(Core \times Core\)</span>, and determine the size of the intersection of this set of pairs with the set <span class="math inline">\(E^∗_{new}\)</span>.</p>
</blockquote>
<h2 id="section-3">4</h2>
<p>定义方法的输入输出。</p>
<p>输入：<span class="math inline">\(G_{collab}\)</span></p>
<p>输出：<span class="math inline">\(score(x, y)\)</span>降序的列表</p>
<p>基本上可以理解为通过原有的图结构计算节点<span class="math inline">\(x,y\)</span>之间的proximity。</p>
<p>最基本的方法就是计算<span class="math inline">\(G_{collab}\)</span>中<span class="math inline">\(x, y\)</span>的最短路径，为了保持结果降序排列，对路径长度取负值，其中等于1的路径属于训练图。</p>
<h2 id="section-4">5</h2>
<p>Methods based on node neighborhoods</p>
<p><span class="math inline">\(\Gamma(x)\)</span>表示图<span class="math inline">\(G_{collab}\)</span>中节点<span class="math inline">\(x\)</span>的邻居的集合。</p>
<p>直觉上来说，相同的邻居更多的连个节点更容易产生关系，这类方法就是基于这个假设。</p>
<h3 id="common-neighbors">Common neighbors</h3>
<p>$score(x, y) := (x)(y)$</p>
<h3 id="jaccards-coefficient-and-adamicadar">Jaccard’s coefficient and Adamic/Adar</h3>
<p>Jaccard’s coefficient通常用于信息检索中的相似度测量，</p>
<p><span class="math inline">\(score(x, y) := \mid\Gamma(x)\cap\Gamma(y)\mid/\mid\Gamma(x)\cup\Gamma(y)\mid\)</span></p>
<p>Adamic/Adar加大了稀有特征的权重，</p>
<p><span class="math inline">\(score(x,y) := \sum\nolimits_{z\in\Gamma(x)\cap\Gamma(y)}\frac{1}{\log\mid\Gamma(z)\mid}\)</span></p>
<h3 id="preferential-attachment">Preferential attachment</h3>
<p>该方法的基本的假设是节点涉及新边的概率与其邻居的数量成正比，</p>
<p><span class="math inline">\(score(x,y) := \mid\Gamma(x)\mid\cdot\mid\Gamma(y)\mid\)</span></p>
<h2 id="section-5">6</h2>
<p>Methods based on the ensemble of all paths</p>
<p>这类方法基于最短路径的思路，不过是考虑了两点之间所有路径。</p>
<h3 id="katz">Katz</h3>
<p><span class="math inline">\(score(x,y) := \sum\limits_{l=1}^{\infty}\beta^l\cdot\mid paths_{x,y}^{\langle l \rangle} \mid\)</span></p>
<p><span class="math inline">\(paths_{x,y}^{\langle l \rangle} := \{paths\ of\ length\ exactly\ l\ from\ x\ to\ y\}\)</span></p>
<p>当<span class="math inline">\(\beta\)</span>值比较小的时候，结果基本与common neighbors方法类似。</p>
<p>此外该方法还分为加权、不加权两种：</p>
<p>weighted: <span class="math inline">\(paths_{x,y}^{\langle 1 \rangle} := number\ of\ collaborations\ between\ x,y.\)</span></p>
<p>unweighted: <span class="math inline">\(paths_{x,y}^{\langle 1 \rangle} := 1\ iff\ x\ and\ y\ collaborate.\)</span></p>
<h3 id="hitting-times-pagerank-and-variants">Hitting times, PageRank, and variants</h3>
<p>该方法的思想是在<span class="math inline">\(G_{collab}\)</span>上进行<em>random walk</em></p>
<p><em>hitting time</em> <span class="math inline">\(H_{x,y}\)</span>标示从<span class="math inline">\(x\)</span>到<span class="math inline">\(y\)</span>的期望的步数</p>
<p><em>commute time</em> <span class="math inline">\(C_{x,y} := H_{x,y} + H_{y,x}\)</span></p>
<p>但是当<span class="math inline">\(y\)</span>的<em>stationary probability</em> <span class="math inline">\(\pi_y\)</span>比较大的时候，对于任意<span class="math inline">\(x\)</span>，<span class="math inline">\(H_{x,y}\)</span>的值都很小，所以做一点儿归一化。</p>
<p><span class="math inline">\(score(x,y) := -H_{x,y}\cdot\pi_y\)</span></p>
<p><span class="math inline">\(score(x,y) := -(H_{x,y}\cdot\pi_y + H_{y,x}\cdot\pi_x)\)</span></p>
<p>但是这种测量方法还有一个问题，其测量值对图部分的结构更敏感，所以在<em>random walk</em>中加入固定的概率<span class="math inline">\(\alpha\)</span>退回。</p>
<blockquote>
<p>rooted PageRank</p>
<p>stationary distribution weight of <span class="math inline">\(y\)</span> under the following random walk:</p>
<p>with probability <span class="math inline">\(\alpha\)</span>, jump to <span class="math inline">\(x\)</span>.</p>
<p>with probability <span class="math inline">\(1-\alpha\)</span>, go to random neighbor of current node.</p>
</blockquote>
<h3 id="simrank">SimRank</h3>
<p><span class="math inline">\(score(x,y) := \begin{equation}\left \{\begin{array}\\\gamma\cdot\frac{\sum\nolimits_{a\in\Gamma(x)}\sum\nolimits_{b\in\Gamma(y)}score(a,b)}{\mid\Gamma(x)\mid\cdot\mid\Gamma(y)\mid} &amp; otherwise \\1 &amp; if\ x = y\end{array}\right.\end{equation}\)</span></p>
<p><span class="math inline">\(\gamma\in[0,1]\)</span></p>
<blockquote>
<p>SimRank can also be interpreted in terms of a random walk on the collaboration graph: it is the expected value of <span class="math inline">\(\gamma^l\)</span>, where <span class="math inline">\(l\)</span> is a random variable giving the time at which random walks started from <span class="math inline">\(x\)</span> and <span class="math inline">\(y\)</span> first meet.</p>
</blockquote>
<h2 id="section-6">7</h2>
<p>Higher-level approaches</p>
<p>三个meta-approaches，可以结合任一上述方法。</p>
<h3 id="low-rank-approximation">Low-rank approximation</h3>
<p>上述算法都可以转换为矩阵运算，那么就可以用SVD降秩，这也可以看做为一种noise-reduction的方法。</p>
<h3 id="unseen-bigrams">Unseen bigrams</h3>
<blockquote>
<p>Link prediction is akin to the problem of estimating frequencies for unseen bigrams in language modeling—pairs of words that co-occur in a test corpus, but not in the corresponding training corpus.</p>
<p>we can augment our estimates for <span class="math inline">\(score(x, y)\)</span> using values of <span class="math inline">\(score(z, y)\)</span> for nodes <span class="math inline">\(z\)</span> that are “similar” to <span class="math inline">\(x\)</span>.</p>
</blockquote>
<p><span class="math inline">\(score_{unweighted}^*(x,y) := \mid\{z:z\in\Gamma(y)\cap S_x^{\langle\delta\rangle}\}\mid\)</span></p>
<p><span class="math inline">\(score_{weighted}^*(x,y) := \sum\nolimits_{z\in\Gamma(y)\cap S_x^{\langle\delta\rangle}}score(x,z)\)</span></p>
<p><span class="math inline">\(S_x^{\langle\delta\rangle}\)</span>表示基于<span class="math inline">\(score(x,\cdot)\)</span>与<span class="math inline">\(x\)</span>最相关的<span class="math inline">\(\delta\)</span>个节点。</p>
<h3 id="clustering">Clustering</h3>
<p>通过聚类删除一些tenuous的边，然后在cleaned-up的子图上进行计算。</p>
<h2 id="section-7">8</h2>
<p>一些结论</p>
<blockquote>
<p>the small world problem is really a problem. The shortest path between two scientists in wholly unrelated disciplines is often very short (and very tenuous).</p>
<p>Overall, the basic graph distance predictor is not competitive with most of the other approaches studied; our most successful link predictors can be viewed as using measures of proximity that are robust to the few edges that result from rare collaborations between fields.</p>
</blockquote>
<p>AA还是不错的。</p>
<blockquote>
<p>The small world problem suggests that there are many pairs with graph distance two that will not collaborate, but we also observe the dual problem: many pairs that collaborate are at distance larger than two.</p>
</blockquote>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/06/15/link_prediction_problem/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-05-26 </div>
			<div class="article-title"><a href="/2015/05/26/geonear/" >关于附近的XXX</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>近来的一个需求——附近的XXX。</p>
<p>google一下，</p>
<p>最方便的解决方案是MongoDB的<a href="http://docs.mongodb.org/manual/reference/command/geoNear/" target="_blank" rel="external">geoNear</a>命令。</p>
<p>无奈我司的DBA属于老成持重型的，所以只能使用MySQL……</p>
<p>怎么办呢？</p>
<h1 id="section-1">2</h1>
<p>假设表：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br><span class="line">| Field       | Type       | Null | Key | Default | Extra |</span><br><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br><span class="line">| xxx_id      | bigint(20) | NO   | PRI | NULL    |       |</span><br><span class="line">| lat         | double     | NO   |     | NULL    |       |</span><br><span class="line">| lon         | double     | NO   |     | NULL    |       |</span><br><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br></pre></td></tr></table></figure>
<p>想找某半径范围内，按照距离远近排序的xxx_id列表，如何写SQL语句呢?</p>
<p>其实我也不会写…… （笑）</p>
<p>不过找到了一个相关的PPT <a href="http://www.notaires.fr/sites/default/files/geo_searchjkkjkj_0.pdf" target="_blank" rel="external">Geo (proximity) Search with MySQL</a></p>
<p>其中给出了SQL语句：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">set</span> @orig_lat=<span class="number">121.9763</span>;</span> <span class="operator"><span class="keyword">set</span> @orig_lon=<span class="number">37.40445</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">set</span> @dist=<span class="number">10</span>;</span></span><br><span class="line"><span class="operator"><span class="keyword">SELECT</span> *, <span class="number">3956</span> * <span class="number">2</span> * <span class="keyword">ASIN</span>(<span class="keyword">SQRT</span>(</span><br><span class="line"><span class="keyword">POWER</span>(<span class="keyword">SIN</span>((@orig_lat - <span class="keyword">abs</span>(dest.lat)) * <span class="keyword">pi</span>()/<span class="number">180</span> / <span class="number">2</span>),</span><br><span class="line"><span class="number">2</span>) + <span class="keyword">COS</span>(@orig_lat * <span class="keyword">pi</span>()/<span class="number">180</span> ) * <span class="keyword">COS</span>(<span class="keyword">abs</span>(dest.lat) *</span><br><span class="line"><span class="keyword">pi</span>()/<span class="number">180</span>) * <span class="keyword">POWER</span>(<span class="keyword">SIN</span>((@orig_lon - dest.lon) *</span><br><span class="line"><span class="keyword">pi</span>()/<span class="number">180</span> / <span class="number">2</span>), <span class="number">2</span>) )) <span class="keyword">as</span> distance</span><br><span class="line"><span class="keyword">FROM</span> hotels dest</span><br><span class="line"><span class="keyword">having</span> distance &lt; @dist</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> distance <span class="keyword">limit</span> <span class="number">10</span>\G</span></span><br></pre></td></tr></table></figure>
<p>这么复杂…… 数据量大的话肯定性能低下。</p>
<p>其中给出了一个解决方案，就是通过计算距离缩小探索空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#176; of latitude ~= 69 miles&#10;1&#176; of longitude ~= cos(latitude)*69&#10;To calculate lon and lat for the rectangle:</span><br></pre></td></tr></table></figure>
<p>当然这个PPT是某个DBA写的……</p>
<p>我们通常不会把这么多计算的逻辑放在mysql上。</p>
<h1 id="section-2">3</h1>
<p>沿着上述缩小探索范围的思路，就很容易想到一个叫做<a href="http://en.wikipedia.org/wiki/Geohash" target="_blank" rel="external">Geohash</a>的算法。</p>
<p>该算法简而言之就是将地图一半一半地切分成一个个小区域，每个小区域计算出一个一维的编码。</p>
<p>Github上有个很不错的项目——<a href="https://github.com/kungfoo/geohash-java" target="_blank" rel="external">geohash-java</a>——可以直接拿来用。</p>
<p>计算Geohash的核心算法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">GeoHash</span><span class="params">(<span class="keyword">double</span> latitude, <span class="keyword">double</span> longitude, <span class="keyword">int</span> desiredPrecision)</span> </span>&#123;</span><br><span class="line">	point = <span class="keyword">new</span> WGS84Point(latitude, longitude);</span><br><span class="line">	desiredPrecision = Math.min(desiredPrecision, <span class="number">64</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">boolean</span> isEvenBit = <span class="keyword">true</span>;</span><br><span class="line">	<span class="keyword">double</span>[] latitudeRange = &#123; -<span class="number">90</span>, <span class="number">90</span> &#125;;</span><br><span class="line">	<span class="keyword">double</span>[] longitudeRange = &#123; -<span class="number">180</span>, <span class="number">180</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (significantBits &lt; desiredPrecision) &#123;</span><br><span class="line">		<span class="keyword">if</span> (isEvenBit) &#123;</span><br><span class="line">			divideRangeEncode(longitude, longitudeRange);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			divideRangeEncode(latitude, latitudeRange);</span><br><span class="line">		&#125;</span><br><span class="line">		isEvenBit = !isEvenBit;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	setBoundingBox(<span class="keyword">this</span>, latitudeRange, longitudeRange);</span><br><span class="line">	bits &lt;&lt;= (<span class="number">64</span> - desiredPrecision);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">divideRangeEncode</span><span class="params">(<span class="keyword">double</span> value, <span class="keyword">double</span>[] range)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">double</span> mid = (range[<span class="number">0</span>] + range[<span class="number">1</span>]) / <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (value &gt;= mid) &#123;</span><br><span class="line">		addOnBitToEnd();</span><br><span class="line">		range[<span class="number">0</span>] = mid;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		addOffBitToEnd();</span><br><span class="line">		range[<span class="number">1</span>] = mid;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以就在表中多个一个字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br><span class="line">| geo_hash_32 | bigint(20) | NO   | MUL | NULL    |       |</span><br><span class="line">+<span class="comment">-------------+------------+------+-----+---------+-------+</span></span><br></pre></td></tr></table></figure>
<p>32表示geohash的bit长度，也就是维度之间大约300米的范围。</p>
<p>另外这还有个好处，如果数据量上来了还可以通过geo_hash_32字段散表。</p>
<h1 id="section-3">4</h1>
<p>最后串一下整个流程：</p>
<p>某用户在A点，半径m米，</p>
<p>首先计算出覆盖这个半径的geo_hash_32列表，</p>
<p>然后从数据库中查询出数据，</p>
<p>最后计算距离、排序</p>
<h1 id="section-4">5</h1>
<p>记得之前看过一篇介绍uber架构的文章——<a href="http://www.infoq.com/news/2015/03/uber-realtime-market-platform" target="_blank" rel="external">Uber Unveils its Realtime Market Platform</a>，</p>
<p>其中提到了一个称为<a href="https://code.google.com/p/s2-geometry-library/" target="_blank" rel="external">s2-geometry-library</a>的类库。</p>
<blockquote>
<p>The S2 Geometry Library is a spherical geometry library, very useful for manipulating regions on the sphere (commonly on Earth) and indexing geographic data.</p>
</blockquote>
<p>具体细节、暂且留坑。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/05/26/geonear/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-04-09 </div>
			<div class="article-title"><a href="/2015/04/09/privoxy/" >小工具Privoxy</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>抓取墙外的内容，</p>
<p>翻墙，</p>
<p>VPN，在程序中调用不方便；代理，比较方便。</p>
<p>有一台墙外的服务器，安装了<a href="https://github.com/shadowsocks/shadowsocks" target="_blank" rel="external">shadowsocks</a></p>
<p>shadowsocks走的是socks5协议，</p>
<p>在程序中调用也不太方便，虽然shadowsocks是用python写的，但是在python3中使用socks5代理真是不方便……</p>
<p>如果能转成HTTP(s)协议就好了~</p>
<h1 id="section-1">2</h1>
<p>怎么办？</p>
<p>有个小工具<a href="http://www.privoxy.org/" target="_blank" rel="external">Privoxy</a></p>
<p>实际上这个工具相对强大，这里只使用了几个简单的功能。</p>
<blockquote>
<p>Privoxy is a non-caching web proxy with advanced filtering capabilities for enhancing privacy, modifying web page data and HTTP headers, controlling access, and removing ads and other obnoxious Internet junk. Privoxy has a flexible configuration and can be customized to suit individual needs and tastes. It has application for both stand-alone systems and multi-user networks.</p>
</blockquote>
<p>编译安装，参考<a href="http://www.privoxy.org/user-manual/installation.html#INSTALLATION-SOURCE" target="_blank" rel="external">2.2. Building from Source</a></p>
<p>配置文件默认位于<code>/usr/local/etc/privoxy</code></p>
<h1 id="section-2">3</h1>
<p>将socks5协议转成HTTP(s)协议</p>
<p>修改<code>config</code>，添加如下规则</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">forward-socks5 / xx.xx.xx.xx:1080 .</span><br></pre></td></tr></table></figure>
<p>为了让外网用户也能访问该服务，修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\#listen-address  127.0.0.1:8118&#10;listen-address  0.0.0.0:8118</span><br></pre></td></tr></table></figure>
<h1 id="section-3">4</h1>
<p>另外需要限制一下可以访问的域名</p>
<p>在添加两个配置文件<code>blacklist.action</code>和<code>whitelist.action</code></p>
<p>内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># blacklist.action&#10;&#123; +block &#125;&#10;/</span><br></pre></td></tr></table></figure>
<p>加过滤，也就是过滤所有域名。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># whitelist.action&#10;&#123; -block &#125;&#10;instagram.com</span><br></pre></td></tr></table></figure>
<p>减过滤，也就是允许访问<code>instagram.com</code></p>
<p>在<code>config</code>添加两行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actionsfile blacklist.action&#10;actionsfile whitelist.action</span><br></pre></td></tr></table></figure>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/04/09/privoxy/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-03-21 </div>
			<div class="article-title"><a href="/2015/03/21/popular_data/" >思考热门发现Tab的内容配置</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>之前有篇文章是介绍<a href="http://shichaoyuan.github.io/engineering/2015/02/12/copy_ins_popular_tab.html">如何山寨Instagram的热门发现Tab</a></p>
<p>其中留了一个坑，如何配置不同类型的数据。</p>
<p>近来跟PM讨论的比较多，所以记一下。</p>
<h1 id="section-1">2</h1>
<p>首先交代一下背景，</p>
<p>小项目、刚起步，</p>
<p>没有什么数据，直接通过data mining的方法不太合适，</p>
<p>所以运营人员会维护一个热门内容库，并且会对热门内容打tag，包括feed和user。</p>
<p>然后是对于发现页的定位，</p>
<p>帮助用户发现自己感兴趣的东西，引导用户关注这些内容。</p>
<h1 id="section-2">3</h1>
<h2 id="第一个想法-直接random">第一个想法 —— 直接Random</h2>
<p>直接对热门内容库随机选择，这个想法最直观，</p>
<p>而且毕竟是经过运营人员筛选出来的，质量通常相当的高。</p>
<p>简单、直接。</p>
<h2 id="第二个想法-以时间做为权重random">第二个想法 —— 以时间做为权重Random</h2>
<p>这是一个很直观的优化，新feed感觉上应该更容易引起支持，特别是某些热门一时的话题。</p>
<p>可以简单这样来算：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">double</span> <span class="title">calculateWeightByTime</span><span class="params">(Date date)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> weight = <span class="number">1.0</span>;</span><br><span class="line">    <span class="keyword">double</span> deltaDay = ((<span class="keyword">double</span>)(System.currentTimeMillis() - date.getTime())) / <span class="number">1000.0</span> / <span class="number">60.0</span> / <span class="number">60.0</span> / <span class="number">24.0</span>;</span><br><span class="line">    <span class="keyword">if</span> (deltaDay &lt; <span class="number">99.0</span>) &#123;</span><br><span class="line">        weight = <span class="number">100</span> - deltaDay;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> weight;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>目前线上的算法就是这个，按照友盟的统计，在热门发现页40%左右的点击会进入feed终端页。</p>
<h1 id="section-3">4</h1>
<h2 id="第三个想法">第三个想法</h2>
<h3 id="问题">问题：</h3>
<p>用户（我们）到底想看到什么内容？</p>
<p>感兴趣的呗。</p>
<p>什么是感兴趣的？</p>
<p>给用户一个列表，让其选择。</p>
<p>根据我们使用app的经历，这个方式比较不靠谱。</p>
<p>为什么？</p>
<p>因为很多时候并不知道自己喜欢什么，所以通常都是随便选几个。</p>
<p>那么现在的问题就是如何获取用户的兴趣。</p>
<h3 id="判断用户的兴趣">判断用户的兴趣</h3>
<p>因为目前有运营的支持，对于优质用户会对其打tag，那么我们可以这样理解用户的兴趣。</p>
<p>用户A关注了用户B，那么用户A的兴趣可以理解为用户B的tags。</p>
<p>这个逻辑总体来说是说的通的，除了礼貌性的互粉，但是身上有tag的用户都是运营筛选出来的，所以这种情况相对不会太多。</p>
<p>另外用户的兴趣也是会变化的，所以基于关注行为判断用户当前的兴趣是一个相对可取的方法。</p>
<p>在于数据量比较少，运营顶得住的情况下，这是一个不错的策略。</p>
<p>当然也可以通过用户点赞和评论的行为，判断用户当前的兴趣。</p>
<p>当数据量上来之后，就可以改为通过协同过滤推荐计算用户当前感兴趣的内容。</p>
<h3 id="问题-1">问题</h3>
<p>既然想出了一种判断用户当前兴趣的方法，那么是否狂推这些内容就行了？</p>
<p>看多了也就看厌了，所以还是想看到一些未知的。</p>
<p>那么现在的问题就是怎么配置已经感兴趣的内容与未知的内容。</p>
<h3 id="配置内容">配置内容</h3>
<p>目前有两个来源：</p>
<ol style="list-style-type: decimal">
<li>运营筛选的。这些内容和用户都会被打tag。</li>
<li>算法计算的。目前是协同过滤推荐，目前来说只是为了丰富一下内容源。</li>
</ol>
<p>基于用户的兴趣，运营筛选的内容可以分为动态的分为两类：</p>
<ol style="list-style-type: decimal">
<li>用户目前感兴趣的内容</li>
<li>未知内容</li>
</ol>
<p>那么怎么控制比例呢？</p>
<p>拍脑袋，第一类80%，第二类20%。</p>
<p>然后根据用户的刷新的次数，依次衰减第一类的比例。</p>
<p>大致的思路就是这样。</p>
<h1 id="section-4">5</h1>
<h2 id="怎么实现">怎么实现</h2>
<p>逻辑比较复杂，怎么兼顾响应时间呢？</p>
<p>大致的实现思路如下：</p>
<p>根据用户的兴趣，将运营筛选的内容分为两类，放到redis中，</p>
<p>当有新的关注行为，也就是新的兴趣时，异步更新redis。</p>
<p>用户拉取热门内容时，</p>
<p>拉取redis中的内容，过滤掉已经关注的用户的内容，</p>
<p>根据时间权重随机选择。</p>
<p>如果内容太少，使用协同过滤推荐计算的内容补全。</p>
<p>最后shuffle一下，搞定。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/03/21/popular_data/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-02-16 </div>
			<div class="article-title"><a href="/2015/02/16/gc_log_1/" >关于JAVA GC LOG —— 如何看</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <p>本文基于Java HotSpot(TM) 64-Bit Server VM (build 24.71-b01, mixed mode)</p>
<h1 id="section">1</h1>
<p>GC相关的几个JVM启动参数：</p>
<table>
<thead>
<tr class="header">
<th align="left">参数</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">-XX:+PrintGCDetails</td>
<td align="left">Print more details at garbage collection. Manageable. (Introduced in 1.4.0.)</td>
</tr>
<tr class="even">
<td align="left">-XX:+PrintGCDateStamps</td>
<td align="left">Enables printing of a date stamp at every GC</td>
</tr>
<tr class="odd">
<td align="left">-Xloggc::filename</td>
<td align="left">Log GC verbose output to specified file. The verbose output is controlled by the normal verbose GC flags.</td>
</tr>
<tr class="even">
<td align="left">-XX:+UseGCLogFileRotation</td>
<td align="left">Enabled GC log rotation, requires -Xloggc.</td>
</tr>
<tr class="odd">
<td align="left">-XX:NumberOfGCLogFiles=1</td>
<td align="left">Set the number of files to use when rotating logs, must be &gt;= 1. The rotated log files will use the following naming scheme, filename.0, filename.1, …, filename.n-1.</td>
</tr>
<tr class="even">
<td align="left">-XX:GCLogFileSize=8K</td>
<td align="left">The size of the log file at which point the log will be rotated, must be &gt;= 8K.</td>
</tr>
<tr class="odd">
<td align="left">-XX:+PrintTenuringDistribution</td>
<td align="left">Print tenuring age information.</td>
</tr>
</tbody>
</table>
<p>其它参数，详见<a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html" target="_blank" rel="external">Java HotSpot VM Options</a></p>
<h1 id="section-1">2</h1>
<p>一个Tomcat/7.0.26的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;JAVA_OPTS=&#34;-server -Xms1500M -Xmx1500M -Xmn500M -Xss256k -XX:PermSize=256m -XX:MaxPermSize=256m -XX:+UseParNewGC -XX:ParallelGCThreads=8 -XX:SurvivorRatio=6 -XX:TargetSurvivorRatio=90 -XX:MaxTenuringThreshold=15 -XX:SoftRefLRUPolicyMSPerMB=0 -XX:+UseConcMarkSweepGC -XX:+CMSIncrementalMode -XX:+UseCMSCompactAtFullCollection -XX:CMSFullGCsBeforeCompaction=5 -XX:CMSInitiatingOccupancyFraction=55 -XX:CMSIncrementalSafetyFactor=20 -XX:+PrintGCDetails -XX:+PrintGCDateStamps -Xloggc:../logs/gc-$DATE.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=128K -XX:+PrintTenuringDistribution &#34;</span><br></pre></td></tr></table></figure>
<p>对于young generation，使用ParNew；对于Tenured generation，使用CMS。</p>
<p>如何配置这些不同的算法，详见<a href="https://blogs.oracle.com/jonthecollector/entry/our_collectors" target="_blank" rel="external">Our Collectors</a></p>
<p>一段GC日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;2015-02-05T19:27:34.537+0800: 3737.811: [Full GC2015-02-05T19:27:34.537+0800: 3737.812: [CMS: 68036K-&#62;71687K(1024000K), 0.3253180 secs] 228627K-&#62;71687K(1472000K), [CMS Perm : 58490K-&#62;58337K(262144K)] icms_dc=0 , 0.3257740 secs] [Times: user=0.33 sys=0.00, real=0.33 secs]&#10;2015-02-05T19:27:34.866+0800: 3738.141: [GC [1 CMS-initial-mark: 71687K(1024000K)] 71689K(1472000K), 0.0041430 secs] [Times: user=0.01 sys=0.00, real=0.01 secs]&#10;2015-02-05T19:27:34.871+0800: 3738.145: [CMS-concurrent-mark-start]&#10;2015-02-05T19:31:25.881+0800: 3969.156: [GC2015-02-05T19:31:25.881+0800: 3969.156: [ParNew&#10;Desired survivor size 58982400 bytes, new threshold 15 (max 15)&#10;- age   1:    8783432 bytes,    8783432 total&#10;: 384000K-&#62;13384K(448000K), 0.0148490 secs] 455687K-&#62;85071K(1472000K) icms_dc=0 , 0.0153590 secs] [Times: user=0.05 sys=0.00, real=0.02 secs]&#10;2015-02-05T19:33:50.170+0800: 4113.445: [GC2015-02-05T19:33:50.171+0800: 4113.445: [ParNew&#10;Desired survivor size 58982400 bytes, new threshold 15 (max 15)&#10;- age   1:    5015016 bytes,    5015016 total&#10;- age   2:    3093632 bytes,    8108648 total</span><br></pre></td></tr></table></figure>
<p>我们仔细看看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;2015-02-05T19:27:34.537+0800:(&#26085;&#26399;) 3737.811:(&#26102;&#38388;&#25139;) [Full GC(&#22403;&#22334;&#25910;&#38598;&#31867;&#22411;)2015-02-05T19:27:34.537+0800:(&#26085;&#26399;) 3737.812:(&#26102;&#38388;&#25139;) [CMS:(&#31639;&#27861;&#20197;&#21450;generation) 68036K-&#62;71687K(1024000K), 0.3253180 secs(Tenured generation&#30340;&#24773;&#20917;)] 228627K-&#62;71687K(1472000K)(&#25972;&#20010;&#22534;&#30340;&#24773;&#20917;), [CMS Perm : 58490K-&#62;58337K(262144K)(Perm&#30340;&#24773;&#20917;)] icms_dc=0 , 0.3257740 secs] [Times: user=0.33 sys=0.00, real=0.33 secs]&#10;&#10;2015-02-05T19:31:25.881+0800: 3969.156: [GC2015-02-05T19:31:25.881+0800: 3969.156: [ParNew&#10;Desired survivor size 58982400 bytes, new threshold 15 (max 15)&#10;- age   1:    8783432 bytes,    8783432 total&#10;: 384000K-&#62;13384K(448000K), 0.0148490 secs] 455687K-&#62;85071K(1472000K) icms_dc=0 , 0.0153590 secs] [Times: user=0.05 sys=0.00, real=0.02 secs]</span><br></pre></td></tr></table></figure>
<p>更加详细的分析，参考<a href="https://blogs.oracle.com/poonam/entry/understanding_cms_gc_logs" target="_blank" rel="external">Understanding CMS GC Logs</a></p>
<h1 id="section-2">3</h1>
<p>如何可视化？</p>
<p>使用<a href="https://github.com/chewiebug/GCViewer" target="_blank" rel="external">GCViewer</a></p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/02/16/gc_log_1/#more" class="btn btn-default more">Read More</a>
</div>

		
			
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2015-02-12 </div>
			<div class="article-title"><a href="/2015/02/12/copy_ins_popular_tab/" >如何高仿Instagram的热门发现Tab</a></div>						
		</h3>
	


			<div class="entry">
  <div class="row">
  
	<div class="col-md-12">
	  
	
	  <h1 id="section">1</h1>
<p>最近在做的项目类似Instagram，其中第二个Tab基本上完全一致……</p>
<p>如何做呢？</p>
<p>首先看看INS是如何做的。</p>
<p>狂刷INS的第二个Tab，发现其中的feed分了两类：“全球热门项目”和“根据你关注的用户”；点击进入feed终端页，感觉内容你预先加载完的（除了照片）。</p>
<p>申请一个开发者账号，调用一下https://api.instagram.com/v1/media/popular?access_token=ACCESS-TOKEN</p>
<p>发现其返回的json包含feed的完整信息。</p>
<h1 id="section-1">2</h1>
<p>我们的需求：</p>
<ol style="list-style-type: decimal">
<li>下拉刷新，根据权重随机呈现；</li>
<li>上滑翻页，分页读取；</li>
<li>多个内容源，比如：运营筛选、算法推荐、地理位置；</li>
<li>可以很用容易改变不同内容源的配比。</li>
</ol>
<p>还有不要太慢 嘻嘻</p>
<h1 id="section-2">3</h1>
<p>总体设计：</p>
<ol style="list-style-type: decimal">
<li>生产内容源；</li>
<li>配比内容源，更新线上内容库；</li>
<li>读取线上内容库，根据权重随机呈现。</li>
</ol>
<p>其中使用Redis做为线上内容库。</p>
<h1 id="section-3">4</h1>
<p>生产内容源</p>
<p>目前有两个：一个mahout的协同过滤推荐算法，一个运营人员筛选。</p>
<p>没什么需要解释的。</p>
<h1 id="section-4">5</h1>
<p>配比内容源，更新线上内容库；</p>
<p>一个定时任务，从不同的内容源中选择不同的配备的内容，然后推送到Redis中。</p>
<p>其中如何设定权重是一个比较有趣的问题，先留坑。</p>
<h1 id="section-5">6</h1>
<p>读取线上内容库，根据权重随机呈现</p>
<p>Redis中数据的组织形式是，userId对应一个redisList，redisList中数据项的序列化和反序列化使用protobuf。</p>
<p>目前设想单个user对应feed的数量为一万左右，如果一次全部读取，并发量较高的时候，程序GC的负担会比较重，所以使用了分段读取的方法——<a href="https://github.com/shichaoyuan/snippets/blob/master/RedisListIterator.java" target="_blank" rel="external">RedisListIterator.java</a>。</p>
<p>如何根据权重随机选择，参考之前的文章——<a href="http://shichaoyuan.github.io/algorithm/2014/12/28/sample_algorithm.html">关于sample算法</a>。</p>
<p>至于分页，用Reids的List也很容易解决。</p>
<h1 id="section-6">7</h1>
<p>该接口的性能基本上严重依赖Redis的性能；</p>
<p>随着用户的增加，Reids集群的容量也得成正比增加。</p>

	
	</div>
	
  
</div>
	<a type="button" href="/2015/02/12/copy_ins_popular_tab/#more" class="btn btn-default more">Read More</a>
</div>

		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>Prev</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">Next<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
<div class="widget">
  <h4>Recent Posts</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2015/08/06/startup-web-playframework/" ><i class="fa fa-file-o"></i>如何快速开始一个小项目 —— playframewor...</a>
      </li>
    
      <li>
        <a href="/2015/08/05/startup-web-spring/" ><i class="fa fa-file-o"></i>如何快速开始一个小项目 —— spring-boot...</a>
      </li>
    
      <li>
        <a href="/2015/07/10/notes-pepfcp/" ><i class="fa fa-file-o"></i>Reading Notes - Prudent Eng...</a>
      </li>
    
      <li>
        <a href="/2015/06/30/weak-reference/" ><i class="fa fa-file-o"></i>weak reference...</a>
      </li>
    
      <li>
        <a href="/2015/06/15/link_prediction_problem/" ><i class="fa fa-file-o"></i>Link Prediction Problem...</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>Links</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/shichaoyuan" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2015 Shichao Yuan
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>





<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


</body>
   </html>
